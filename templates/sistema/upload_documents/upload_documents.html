{% extends 'sistema/base.html' %}
{% load static %}

{% block content %}
<style>
  /* Força visual Taskfy */
  body, .container-fluid, .container {
    background: #f7f8fa !important;
  }

  .tfy-wrap { max-width: 760px; margin: 24px auto; }

  .tfy-card {
    background: #fff; border-radius: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    padding: 18px 18px 12px 18px; border: 1px solid #eceef3;
  }

  .tfy-title {
    display:flex; align-items:center; gap:10px;
    font-weight: 800; letter-spacing:.2px; color:#23272e; margin:0 0 8px 0;
  }
  .tfy-sub { color:#6b7280; font-size:.95rem; margin-bottom: 14px; }

  .tfy-zone {
    border: 1.5px dashed #d0d7de; border-radius: 14px;
    background: linear-gradient(180deg, #fafbff, #f7f8fa);
    padding: 18px; text-align: center; transition: all .15s ease;
  }
  .tfy-zone.tfy-highlight { border-color:#23272e; background:#f3f4f7; transform: scale(1.01); }
  .tfy-zone .ico { font-size: 28px; color:#23272e; opacity:.9 }
  .tfy-zone .line1 { font-weight:700; color:#23272e; margin-top:6px; }
  .tfy-zone .line2 { font-size:.9rem; color:#6b7280; }

  .tfy-filelist { margin-top: 14px; }
  .tfy-file {
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    background:#fbfbfd; border:1px solid #eceef3; border-radius:12px;
    padding:10px 12px; margin-bottom:8px;
  }
  .tfy-file-left { display:flex; align-items:center; gap:10px; min-width:0; }
  .tfy-file .fa-file-pdf { font-size:18px; color:#e11d48; }
  .tfy-file-name { font-weight:600; color:#23272e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:420px; }
  .tfy-file-meta { font-size:.85rem; color:#6b7280; }
  .tfy-badge-ok { background:#e8fff3; color:#047857; border:1px solid #c7f9df; padding:2px 8px; border-radius:999px; font-size:.78rem; font-weight:700; }
  .tfy-badge-err { background:#fff1f2; color:#b91c1c; border:1px solid #fecaca; padding:2px 8px; border-radius:999px; font-size:.78rem; font-weight:700; }
  .tfy-remove { border:none; background:#fff; color:#6b7280; padding:6px 8px; border-radius:8px; }
  .tfy-remove:hover { background:#f1f5f9; color:#111827; }

  .tfy-actions { display:flex; gap:8px; margin-top: 14px; }
  .tfy-actions .btn { border-radius:10px; padding:8px 14px; }
  .tfy-hint { font-size:.85rem; color:#6b7280; margin-top:2px; }

  .tfy-alerts .alert { border-radius:12px; }
</style>

<div class="container tfy-wrap">
  <div class="tfy-header d-flex align-items-center justify-content-between mb-2">
    <h4 class="tfy-title">
      <i class="fa-solid fa-file-upload"></i> Upload Documents
    </h4>
    <a href="{% url 'jobcards_list' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fa-solid fa-arrow-left"></i> Back
    </a>
  </div>
  <div class="tfy-sub">PDF only • Multiple files • Validated before submit</div>

  {% if messages %}
    <div class="tfy-alerts mb-2">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }} mb-2">
          {{ m }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <form id="uploadForm"
        action="{% url 'upload_documents' %}"
        method="post"
        enctype="multipart/form-data"
        class="tfy-card">
    {% csrf_token %}

    <!-- Dropzone -->
    <div id="dropzone" class="tfy-zone" role="button" tabindex="0" aria-label="Upload PDFs by clicking or dragging into this area">
      <div class="ico"><i class="fa-regular fa-file-pdf"></i></div>
      <div class="line1">Drop PDF files here or click to select</div>
      <div class="line2">Only .pdf — Max {{ MAX_SIZE_MB|default:50 }}MB each</div>
      <input type="file"
             id="documents"
             name="documents"
             accept=".pdf,application/pdf"
             multiple
             style="display:none" />
    </div>

    <!-- Lista de arquivos -->
    <div id="fileList" class="tfy-filelist" aria-live="polite"></div>

    <div class="tfy-actions">
      <button id="btnUpload" type="submit" class="btn btn-primary" disabled>
        <span class="label"><i class="fa-solid fa-cloud-arrow-up me-1"></i> Upload</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      </button>
      <button id="btnClear" type="button" class="btn btn-light border">Clear</button>
    </div>

    <div class="tfy-hint">Tip: you can drag more files to add them before sending.</div>
  </form>
</div>

<script>
(function() {
  const MAX_MB = parseInt('{{ MAX_SIZE_MB|default:50 }}', 10);
  const input = document.getElementById('documents');
  const dz = document.getElementById('dropzone');
  const list = document.getElementById('fileList');
  const btnUpload = document.getElementById('btnUpload');
  const btnClear = document.getElementById('btnClear');
  const form = document.getElementById('uploadForm');

  /** Estado controlado para conseguirmos adicionar/remover arquivos programaticamente */
  let selected = [];

  function formatSize(bytes) {
    if (bytes >= 1048576) return (bytes/1048576).toFixed(2) + ' MB';
    if (bytes >= 1024) return (bytes/1024).toFixed(0) + ' KB';
    return bytes + ' B';
  }

  function isPDF(f) {
    // checa extensão e MIME
    const nameOk = /\.pdf$/i.test(f.name);
    const typeOk = (f.type || '').toLowerCase() === 'application/pdf';
    return nameOk || typeOk;
  }

  function validateFile(f) {
    const errors = [];
    if (!isPDF(f)) errors.push('Not PDF');
    if (f.size > MAX_MB * 1024 * 1024) errors.push('Too large');
    return { ok: errors.length === 0, errors };
  }

  function renderList() {
    list.innerHTML = '';
    let anyValid = false;
    selected.forEach((item, idx) => {
      const { file, ok, errors } = item;
      if (ok) anyValid = true;

      const row = document.createElement('div');
      row.className = 'tfy-file';

      const left = document.createElement('div');
      left.className = 'tfy-file-left';
      left.innerHTML = `
        <i class="fa-regular fa-file-pdf"></i>
        <div style="min-width:0">
          <div class="tfy-file-name" title="${file.name}">${file.name}</div>
          <div class="tfy-file-meta">${formatSize(file.size)}</div>
        </div>
      `;

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.alignItems = 'center';
      right.style.gap = '8px';

      const badge = document.createElement('span');
      badge.className = ok ? 'tfy-badge-ok' : 'tfy-badge-err';
      badge.textContent = ok ? 'OK' : errors.join(' • ');
      right.appendChild(badge);

      const rm = document.createElement('button');
      rm.type = 'button';
      rm.className = 'tfy-remove';
      rm.innerHTML = '<i class="fa-solid fa-xmark"></i>';
      rm.addEventListener('click', () => {
        selected.splice(idx, 1);
        syncInputFiles();
        renderList();
      });
      right.appendChild(rm);

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    });

    btnUpload.disabled = !anyValid;
  }

  function syncInputFiles() {
    const dt = new DataTransfer();
    selected.forEach(s => { if (s.ok) dt.items.add(s.file); });
    input.files = dt.files;
  }

  function addFiles(fileList) {
    const incoming = Array.from(fileList);
    // Evita duplicados pelo nome+tamanho
    const keys = new Set(selected.map(s => s.file.name + '|' + s.file.size));
    incoming.forEach(f => {
      const key = f.name + '|' + f.size;
      if (!keys.has(key)) {
        const v = validateFile(f);
        selected.push({ file: f, ok: v.ok, errors: v.errors });
        keys.add(key);
      }
    });
    syncInputFiles();
    renderList();
  }

  dz.addEventListener('click', () => input.click());
  dz.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); }});

  dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('tfy-highlight'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('tfy-highlight'));
  dz.addEventListener('drop', (e) => {
    e.preventDefault();
    dz.classList.remove('tfy-highlight');
    addFiles(e.dataTransfer.files);
  });

  input.addEventListener('change', (e) => addFiles(e.target.files));

  btnClear.addEventListener('click', () => {
    selected = [];
    syncInputFiles();
    renderList();
  });

  form.addEventListener('submit', () => {
    // UX: spinner + trava
    btnUpload.querySelector('.label').classList.add('d-none');
    btnUpload.querySelector('.spinner-border').classList.remove('d-none');
    btnUpload.disabled = true;
  });

  // inicial
  renderList();
})();
</script>
{% endblock %}
