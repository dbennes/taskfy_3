{% extends 'sistema/base.html' %}
{% load static %}

{% block content %}
<style>
  body, .container { background:#f7f8fa !important; }
  .card-clean { background:#fff; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); border:1px solid #eceff3; }
  .section-title { font-weight:700; letter-spacing:.01em; font-size:1rem; color:#232323; margin-bottom:8px; }
  .muted { color:#6b7280; font-size:.9rem; }
  .readonly-chip { display:inline-block; padding:6px 10px; border:1px dashed #d1d5db; border-radius:10px; background:#f3f4f6; font-weight:600; }
  .small-label { font-size:.88rem; color:#4b5563; }
  .chip { padding:.35rem .6rem; border-radius:999px; font-weight:600; font-size:.8rem; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer; }
  .chip.active { border-color:#2563eb; background:#eff6ff; color:#1d4ed8; }
  .toolbar { gap:.5rem; flex-wrap:wrap; }
  .toolbar .btn { border-radius:10px; }
  .sidebar-item { display:flex; justify-content:space-between; align-items:center; padding:.4rem 0; border-bottom:1px dashed #eef2f7; }
  .sidebar-item:last-child { border-bottom:0; }
  .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:.4rem; }
  .dot-danger { background:#ef4444; } .dot-warning { background:#f59e0b; } .dot-info { background:#3b82f6; } .dot-success { background:#10b981; }
  .field-hint { font-size:.8rem; color:#94a3b8; }
  .input-group .btn { border-radius:0 .5rem .5rem 0; }
  .sticky-save { position:sticky; bottom:0; background:#fff; border-top:1px solid #eceff3; padding:.75rem; display:flex; justify-content:space-between; align-items:center; border-radius:0 0 16px 16px; }
  @media (min-width: 992px) { .sticky-lg-top-16 { position: sticky; top: 16px; } }
</style>

<div class="container py-3" style="max-width:1200px;">
  {% if messages %}
    <div class="mb-2">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }} mb-2">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-3">
    <!-- COLUNA PRINCIPAL -->
    <div class="col-12 col-lg-8">
      <div class="card-clean mb-3">
        <!-- HEADER -->
        <div class="p-3 border-bottom" style="background:#f5f7fb;">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <div class="small-label">Editando</div>
              <h5 class="mb-1">
                JobCard <span class="readonly-chip">{{ jobcard.job_card_number }}</span>
              </h5>
              <div class="toolbar d-flex">
                <!-- Quick status chips (clicou, troca o select de status) -->
                {% comment %} Ajuste os rótulos conforme seu domínio {% endcomment %}
                <span class="chip js-status" data-value="NO CHECKED"><span class="status-dot dot-danger"></span>NO CHECKED</span>
                <span class="chip js-status" data-value="PRELIMINARY JOBCARD CHECKED"><span class="status-dot dot-info"></span>PRELIMINARY</span>
                <span class="chip js-status" data-value="PLANNING JOBCARD CHECKED"><span class="status-dot dot-warning"></span>PLANNING</span>
                <span class="chip js-status" data-value="OFFSHORE FIELD JOBCARD CHECKED"><span class="status-dot dot-info"></span>OFFSHORE</span>
                <span class="chip js-status" data-value="APPROVED TO EXECUTE"><span class="status-dot dot-success"></span>APPROVED</span>
                <span class="chip js-status" data-value="JOBCARD FINALIZED"><span class="status-dot dot-success"></span>FINALIZED</span>
              </div>
            </div>
            <div class="text-end">
              <div class="small-label">Última modificação</div>
              <div class="muted">
                {{ jobcard.last_modified_by|default:"—" }} · {{ jobcard.last_modified_at|date:"d/m/Y H:i" }}
              </div>
              <div class="mt-2">
                <a class="btn btn-sm btn-outline-primary" href="{% url 'generate_pdf' jobcard.job_card_number %}">
                  <i class="fas fa-file-pdf me-1"></i>Gerar PDF
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- FORM -->
        <form method="post" class="p-3" id="jobcardEditForm" novalidate>
          {% csrf_token %}

          {% if form.job_card_number_display %}
          <div class="mb-3">
            {{ form.job_card_number_display.label_tag }}
            {{ form.job_card_number_display }}
            <div class="field-hint">Número é somente leitura. Use esta tela para atualizar os demais campos.</div>
          </div>
          {% endif %}

          <!-- Datas & Status -->
          <div class="section-title">Schedule & Status</div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">{{ form.start.label_tag }}{{ form.start }}<div class="field-hint">Data de início</div></div>
            <div class="col-md-3">{{ form.finish.label_tag }}{{ form.finish }}<div class="field-hint">Data de término</div></div>
            <div class="col-md-3">
              {{ form.jobcard_status.label_tag }}{{ form.jobcard_status }}
              <div class="field-hint">Use os chips acima para preencher rápido</div>
            </div>
            <div class="col-md-3">{{ form.status.label_tag }}{{ form.status }}</div>
          </div>

          <!-- Códigos & Tag -->
          <div class="section-title">Codes & Tag</div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">{{ form.system.label_tag }}{{ form.system }}</div>
            <div class="col-md-3">{{ form.subsystem.label_tag }}{{ form.subsystem }}</div>
            <div class="col-md-3">{{ form.working_code.label_tag }}{{ form.working_code }}</div>
            <div class="col-md-3">{{ form.tag.label_tag }}{{ form.tag }}</div>
          </div>

          <!-- Descrições -->
          <div class="section-title">Descriptions</div>
          <div class="row g-3 mb-3">
            <div class="col-12">{{ form.working_code_description.label_tag }}{{ form.working_code_description }}</div>
            <div class="col-12">{{ form.job_card_description.label_tag }}{{ form.job_card_description }}</div>
            <div class="col-12">{{ form.comments.label_tag }}{{ form.comments }}</div>
          </div>

          <!-- Métricas -->
          <div class="section-title">Metrics</div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">{{ form.total_weight.label_tag }}{{ form.total_weight }}</div>
            <div class="col-md-3">{{ form.unit.label_tag }}{{ form.unit }}</div>
            <div class="col-md-3">
              <label class="form-label">Total Duration (hs)</label>
              <div class="input-group">
                {{ form.total_duration_hs }}
                <button type="button" class="btn btn-outline-secondary js-format-2d" data-target-id="id_total_duration_hs">.00</button>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Total Man Hours</label>
              <div class="input-group">
                {{ form.total_man_hours }}
                <button type="button" class="btn btn-outline-secondary js-format-2d" data-target-id="id_total_man_hours">.00</button>
              </div>
            </div>
          </div>

          <!-- KPI / Rev / Hot Work -->
          <div class="section-title">KPI, Revision & Safety</div>
          <div class="row g-3 mb-3">
            <div class="col-md-3">{{ form.indice_kpi.label_tag }}{{ form.indice_kpi }}</div>
            <div class="col-md-3">
              <label class="form-label">Revision</label>
              <div class="input-group">
                {{ form.rev }}
                <button type="button" class="btn btn-outline-primary" id="btnRevUp"><i class="fas fa-plus"></i></button>
              </div>
              <div class="field-hint">Incrementa automaticamente se for numérica</div>
            </div>
            <div class="col-md-3">
              <label class="form-label d-block">Hot Work</label>
              <!-- Switch bonito controlando o field original -->
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="hotWorkSwitch">
                <label class="form-check-label" for="hotWorkSwitch">Required?</label>
              </div>
              <div class="field-hint">Alterna entre YES/NO</div>
              <!-- mantém o original visível caso prefira -->
              <div class="mt-2">{{ form.hot_work_required }}</div>
            </div>
          </div>

          <!-- Preparação & Aprovação (expandível) -->
          <div class="section-title d-flex align-items-center justify-content-between">
            <span>Prepared & Approved</span>
            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#preparedBlock">
              <i class="fas fa-chevron-down me-1"></i>Mostrar/Ocultar
            </button>
          </div>
          <div class="collapse show" id="preparedBlock">
            <div class="row g-3 mb-3">
              <div class="col-md-4">{{ form.prepared_by.label_tag }}{{ form.prepared_by }}</div>
              <div class="col-md-4">{{ form.date_prepared.label_tag }}{{ form.date_prepared }}</div>
              <div class="col-md-4">{{ form.approved_br.label_tag }}{{ form.approved_br }}</div>
              <div class="col-md-4">{{ form.date_approved.label_tag }}{{ form.date_approved }}</div>
            </div>
          </div>

          <!-- BAR STICKY DE AÇÕES -->
          <div class="sticky-save">
            <div class="muted"><i class="fas fa-info-circle me-1"></i>Você pode aplicar patch via Excel/CSV.</div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#patchModal">
                <i class="fas fa-file-upload me-1"></i>Patch Excel/CSV
              </button>
              <a href="{% url 'jobcards_list' %}" class="btn btn-light">Cancelar</a>
              <button type="submit" class="btn btn-primary">
                <span class="me-1"><i class="fas fa-save"></i></span> Salvar alterações
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- COLUNA LATERAL -->
    <div class="col-12 col-lg-4">
      <div class="card-clean sticky-lg-top-16">
        <div class="p-3 border-bottom" style="background:#f5f7fb;">
          <h6 class="mb-0">Resumo</h6>
        </div>
        <div class="p-3">
          <div class="sidebar-item"><span class="small-label">JobCard</span> <strong>{{ jobcard.job_card_number }}</strong></div>
          <div class="sidebar-item"><span class="small-label">Discipline</span> <span>{{ jobcard.discipline|default:"—" }}</span></div>
          <div class="sidebar-item"><span class="small-label">Location</span> <span>{{ jobcard.location|default:"—" }}</span></div>
          <div class="sidebar-item"><span class="small-label">Status</span> <span>{{ jobcard.jobcard_status|default:"—" }}</span></div>
          <div class="sidebar-item"><span class="small-label">Rev</span> <span>{{ jobcard.rev|default:"—" }}</span></div>
          <div class="mt-3 d-grid gap-2">
            <button type="button" class="btn btn-outline-secondary" id="btnCopyNumber">
              <i class="fas fa-copy me-1"></i>Copiar número
            </button>
            <a class="btn btn-outline-primary" href="{% url 'generate_pdf' jobcard.job_card_number %}">
              <i class="fas fa-file-pdf me-1"></i>Gerar PDF
            </a>
          </div>
          <hr>
          <div class="small-label mb-1">Dicas rápidas</div>
          <ul class="mb-0 muted" style="padding-left:1rem;">
            <li>Use os chips para mudar o status rapidamente.</li>
            <li>Rev +1 incrementa revisões numéricas.</li>
            <li>“Patch Excel/CSV” atualiza vários campos de uma vez.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Patch via Excel/CSV -->
<div class="modal fade" id="patchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{% url 'modify_jobcard_excel_patch' jobcard.job_card_number %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Patch via Excel/CSV</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          Envie um arquivo <strong>.xlsx</strong> (Excel) ou <strong>.csv</strong> com cabeçalhos iguais aos nomes dos campos
          (ex.: <code>prepared_by</code>, <code>jobcard_status</code>, <code>comments</code>, ...).
          Apenas os campos permitidos serão atualizados.
        </p>
        <input type="file" name="file" accept=".xlsx,.csv" class="form-control" required>
        <small class="text-muted">Somente a primeira linha de dados é aplicada.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Fechar</button>
        <button class="btn btn-primary" type="submit">Aplicar Patch</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  // 1) Avisa sobre alterações não salvas
  const form = document.getElementById("jobcardEditForm");
  let dirty = false;
  form.addEventListener("change", () => dirty = true);
  window.addEventListener("beforeunload", function (e) { if (dirty) { e.preventDefault(); e.returnValue = ""; } });
  form.addEventListener("submit", () => { dirty = false; });

  // 2) Aplica classes Bootstrap em widgets padrão (se o form não já aplica)
  document.querySelectorAll("#jobcardEditForm input[type='text'],#jobcardEditForm input[type='number'],#jobcardEditForm input[type='date'],#jobcardEditForm textarea").forEach(el=>{
    if(!el.classList.contains("form-control")) el.classList.add("form-control");
  });
  document.querySelectorAll("#jobcardEditForm select").forEach(el=>{
    if(!el.classList.contains("form-select")) el.classList.add("form-select");
  });

  // 3) Date inputs: força tipo date se suportado
  ["id_start","id_finish","id_date_prepared","id_date_approved"].forEach(id=>{
    const el = document.getElementById(id);
    if(el && !el.type.includes("date")) { try { el.type = "date"; } catch(e){} }
  });

  // 4) Chips de status → setam o select
  const statusSelect = document.getElementById("id_jobcard_status");
  const chips = document.querySelectorAll(".js-status");
  function highlightChip(value){
    chips.forEach(c => c.classList.toggle("active", c.dataset.value === value));
  }
  chips.forEach(ch=>{
    ch.addEventListener("click", ()=>{
      if(statusSelect){
        statusSelect.value = ch.dataset.value;
        highlightChip(statusSelect.value);
        dirty = true;
      }
    });
  });
  if(statusSelect){ highlightChip(statusSelect.value); }

  // 5) Rev +1 se numérico
  const btnRevUp = document.getElementById("btnRevUp");
  if(btnRevUp){
    btnRevUp.addEventListener("click", ()=>{
      const rev = document.getElementById("id_rev");
      if(!rev) return;
      const v = (rev.value || "").trim();
      if(/^\d+$/g.test(v)){ rev.value = String(parseInt(v,10)+1); dirty = true; }
      else { rev.classList.add("is-invalid"); setTimeout(()=>rev.classList.remove("is-invalid"), 1200); }
    });
  }

  // 6) Hot Work switch ↔ select YES/NO (mantém ambos sincronizados)
  const hotSwitch = document.getElementById("hotWorkSwitch");
  const hotSelect = document.getElementById("id_hot_work_required");
  if(hotSwitch && hotSelect){
    // inicial
    hotSwitch.checked = (String(hotSelect.value).toUpperCase() === "YES");
    // UI → model
    hotSwitch.addEventListener("change", ()=>{
      hotSelect.value = hotSwitch.checked ? "YES" : "NO";
      dirty = true;
    });
    // model → UI (se usuário mudar manualmente)
    hotSelect.addEventListener("change", ()=>{
      hotSwitch.checked = (String(hotSelect.value).toUpperCase() === "YES");
      dirty = true;
    });
  }

  // 7) Botões .00 para formatar 2 casas
  document.querySelectorAll(".js-format-2d").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.targetId;
      const el = document.getElementById(id);
      if(!el) return;
      const raw = (el.value || "").replace(",", ".").trim();
      const num = parseFloat(raw);
      if(!isNaN(num)){
        el.value = num.toFixed(2);
        dirty = true;
      }else{
        el.classList.add("is-invalid");
        setTimeout(()=>el.classList.remove("is-invalid"), 1200);
      }
    });
  });

  // 8) Copiar número
  const btnCopy = document.getElementById("btnCopyNumber");
  if(btnCopy){
    btnCopy.addEventListener("click", async ()=>{
      const text = "{{ jobcard.job_card_number }}";
      try { await navigator.clipboard.writeText(text); btnCopy.classList.add("btn-success"); setTimeout(()=>btnCopy.classList.remove("btn-success"), 1200);} catch(e){}
    });
  }

  // 9) Atalho Ctrl/Cmd+S para salvar
  window.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
      e.preventDefault();
      form.requestSubmit();
    }
  });
})();
</script>
{% endblock %}
