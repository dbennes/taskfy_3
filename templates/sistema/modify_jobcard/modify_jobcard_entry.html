{% extends 'sistema/base.html' %}
{% load static %}

{% block content %}
<style>
  /* ===== Design tokens (Taskfy) ===== */
  :root{
    --bg:#f7f8fa; --panel:#ffffff; --ink:#0b0b0c; --muted:#6b7280;
    --line:#eceff3; --line-strong:#d9dee7; --hover:#f6f8fe; --zebra:#fbfcff;
    --accent:#111111; --accent-ghost:#171717;
    --radius:12px; --radius-lg:14px; --shadow:0 4px 14px rgba(16,24,40,.06);
    --green:#28c840; --red:#ff5f57; --yellow:#febc2e; --dark:#313131;
    --success:#16a34a; --warning:#f59e0b; --danger:#dc2626; --primary:#0d6efd;
  }

  body, .container-fluid { background:var(--bg) !important; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

  /* ===== Cards / textos (minimal) ===== */
  .card-clean { background:#fff; border-radius:var(--radius-lg); box-shadow:var(--shadow); border:1px solid var(--line); overflow:hidden; }
  .section-head { background:#f5f7fb; border-bottom:1px solid var(--line); padding:12px 14px; }
  .muted { color:var(--muted); font-size:.9rem; }

  /* ===== Topbar minimal ===== */
  .topbar-black{
    position: sticky; top: 10px; z-index: 1010;
    background:#fff; border-radius:12px; padding:10px 12px; margin-bottom:12px;
    border:1px solid var(--line); box-shadow:var(--shadow);
  }
  .topbar-black .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; opacity:.9; }
  .dot.red{background:var(--red)} .dot.yellow{background:var(--yellow)} .dot.green{background:var(--green)}
  .topbar-title{ color:var(--ink); margin:0; font-size:.95rem; font-weight:600; letter-spacing:0; }

  .btn-topbar{
    --bs-btn-padding-y:.42rem; --bs-btn-padding-x:.7rem; --bs-btn-font-size:.82rem;
    border-radius:10px; font-weight:600;
  }
  .topbar-black .btn-outline-light{
    --bs-btn-color:#374151; --bs-btn-border-color:#e5e7eb; --bs-btn-hover-bg:#f3f4f6;
    --bs-btn-hover-color:#111827; --bs-btn-hover-border-color:#d1d5db; --bs-btn-active-bg:#eef2f7;
    background:#fff;
  }

  /* ===== Shortcuts ===== */
  .shortcut-item{
    border:1px solid var(--line); border-radius:12px; background:#fff; padding:10px 12px;
    transition: transform .08s ease, box-shadow .12s ease, border-color .12s;
  }
  .shortcut-item:hover{ border-color:var(--line-strong); box-shadow:0 8px 18px rgba(16,24,40,.06); transform: translateY(-1px); }
  .shortcut-item .chev{ width:22px; height:22px; border-radius:50%; background:#f3f4f6; color:#111; display:inline-grid; place-items:center; font-weight:700; }

  /* ===== KPI e progresso ===== */
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; }
  .kpi .item{ background:#fafbff; border:1px solid #eef2f7; border-radius:10px; padding:8px 10px; min-width:120px; }
  .kpi .label{ font-size:.72rem; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; }
  .kpi .value{ font-weight:700; color:#111; }
  .progress{ height: 10px; background:#eef2f7; border-radius:999px; }
  .progress-bar{ background:var(--primary); font-size:.7rem; }

  /* ===== Log ===== */
  #regenLog{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0b0b0c08; border:1px dashed var(--line-strong); }

  /* ===== Acessibilidade ===== */
  :is(button,a,input,select,.shortcut-item):focus-visible{
    outline: 2px solid #93c5fd; outline-offset: 2px; box-shadow: 0 0 0 4px rgba(147,197,253,.2);
  }

  @media (min-width: 992px) { .sticky-lg-top-16{ position: sticky; top: 16px; } }
</style>

<div class="container-fluid mt-2">

  <!-- Topbar minimal -->
  <div class="d-flex align-items-center justify-content-between topbar-black">
    <div class="d-flex align-items-center">
      <span class="dot red me-1"></span>
      <span class="dot yellow me-1"></span>
      <span class="dot green"></span>
      <h6 class="topbar-title ms-3">JobCards — Mass Update (Excel/CSV)</h6>
    </div>
    <div class="d-flex gap-2">
      <button id="btnSyncAll" class="btn btn-primary btn-sm btn-topbar" data-url="{% url 'jobcard_sync_allocations_all' %}">
        <i class="fa fa-arrows-rotate me-1"></i> Sync ALL JobCards
      </button>
      <button type="button" class="btn btn-outline-light btn-sm btn-topbar" data-bs-toggle="modal" data-bs-target="#regenModal">
        <i class="fa fa-sync-alt me-1"></i> Regenerate PDFs
      </button>
      <a href="{% url 'download_jobcard_template' %}" class="btn btn-outline-light btn-sm btn-topbar">
        <i class="fa fa-download me-1"></i> Template
      </a>
      <button type="button" class="btn btn-outline-light btn-sm btn-topbar" onclick="exportJobcardsExcel()">
        <i class="fa fa-file-excel me-1"></i> Export Excel
      </button>
      <button type="button" class="btn btn-outline-light btn-sm btn-topbar" data-bs-toggle="modal" data-bs-target="#importJobcardModal">
        <i class="fa fa-upload me-1"></i> Import
      </button>
    </div>
  </div>

  {% if messages %}
    <div class="mb-2">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }} mb-2">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-3">
    <!-- LEFT: form -->
    <div class="col-12 col-lg-6">
      <div class="card-clean mb-3">
        <div class="section-head">
          <h5 class="mb-0" style="font-weight:600;">Modify JobCard</h5>
          <div class="muted">Type the JobCard number to open the editor.</div>
        </div>

        <form method="post" class="p-3" novalidate>
          {% csrf_token %}
          <label class="form-label">JobCard Number</label>
          <input name="job_card_number" class="form-control mb-3" placeholder="A09.PS-EL-0001" list="jobcardsList" autofocus required>
          <datalist id="jobcardsList">
            {% for jc in recent_jobcards %}
              <option value="{{ jc.job_card_number }}">{{ jc.job_card_number }} — {{ jc.discipline }} {{ jc.location }}</option>
            {% endfor %}
          </datalist>
          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'modify_jobcard_entry' %}" class="btn btn-light">Clear</a>
            <button class="btn btn-primary" type="submit">Continue</button>
          </div>
        </form>
      </div>
    </div>

    <!-- RIGHT: shortcuts -->
    <div class="col-12 col-lg-6">
      <div class="card-clean sticky-lg-top-16">
        <div class="section-head d-flex align-items-center justify-content-between">
          <h6 class="mb-0" style="font-weight:600;">Shortcuts (recent)</h6>
          <span class="badge text-bg-light">{{ recent_jobcards|length }}</span>
        </div>
        <div class="p-3">
          <input id="shortcutFilter" type="text" class="form-control mb-3" placeholder="Filter by number, discipline or area...">
          <div id="shortcutsList" class="row g-2">
            {% for jc in recent_jobcards %}
              <div class="col-12 js-shortcut">
                <a class="shortcut-item d-flex align-items-center text-decoration-none"
                   href="{% url 'modify_jobcard_edit' jobcard=jc.job_card_number %}">
                  <div class="flex-grow-1">
                    <strong class="text-dark" style="font-weight:600;">{{ jc.job_card_number }}</strong>
                    <div class="muted">
                      {{ jc.discipline }} · {{ jc.location }}{% if jc.last_modified_at %} · {{ jc.last_modified_at|date:"d/m/Y H:i" }}{% endif %}
                    </div>
                  </div>
                  <span class="ms-2 chev">&rsaquo;</span>
                </a>
              </div>
            {% empty %}
              <div class="col-12 muted">No suggestions yet.</div>
            {% endfor %}
          </div>
          <div id="shortcutsEmpty" class="text-center text-muted d-none">
            <i class="fa-regular fa-face-thinking me-1"></i>No results for this filter.
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ====================== MODAIS (PADRÃO BOOTSTRAP) ====================== -->

<!-- MODAL: Import -->
<div class="modal fade" id="importJobcardModal" tabindex="-1" aria-labelledby="importJobcardModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="importJobcardForm" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importJobcardModalLabel">Import JobCard (Excel/CSV)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Download the <b>Template</b>, fill the desired columns and upload it here.<br>
          <small class="text-muted">Only provided columns will be updated; always identify by <code>job_card_number</code>.</small></p>
          <input type="file" name="file" id="importJobcardFile" accept=".xlsx,.csv" required class="form-control"/>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Import</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Result (import) -->
<div class="modal fade" id="resultJobcardModal" tabindex="-1" aria-labelledby="resultJobcardModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultJobcardModalLabel">Import Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="resultJobcardModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Regenerate PDFs -->
<div class="modal fade" id="regenModal" tabindex="-1" aria-labelledby="regenModalLabel" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex flex-column">
          <h5 class="modal-title" id="regenModalLabel">Regenerate PDFs</h5>
          <small class="text-muted">All JobCards whose status is <b>not</b> <code>NO CHECKED</code> / <code>NOT CHECKED</code> will be processed.</small>
        </div>
        <div class="ms-3 d-flex align-items-center">
          <span id="regenStatus" class="badge rounded-pill bg-secondary me-2">IDLE</span>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="regenCloseBtn"></button>
        </div>
      </div>

      <div class="modal-body">
        <div id="regenHeartbeat" class="d-flex align-items-center small text-muted mb-2" aria-live="polite">
          <span id="regenSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <span id="regenHeartbeatText"></span>
        </div>

        <div class="progress mb-2" role="progressbar" aria-label="Progress">
          <div id="regenProgress" class="progress-bar" style="width:0%;">0%</div>
        </div>

        <div class="kpi mb-2">
          <div class="item"><div class="label">Total</div><div class="value" id="regenTotal">0</div></div>
          <div class="item"><div class="label">Done</div><div class="value" id="regenDone">0</div></div>
          <div class="item"><div class="label">Failed</div><div class="value" id="regenFail">0</div></div>
          <div class="item"><div class="label">Elapsed</div><div class="value" id="regenElapsed">00:00</div></div>
          <div class="item"><div class="label">ETA</div><div class="value" id="regenETA">--</div></div>
          <div class="item"><div class="label">Throughput</div><div class="value"><span id="regenTPS">0</span>/s</div></div>
          <div class="item"><div class="label">Run ID</div><div class="value" id="regenRunId">—</div></div>
        </div>

        <pre id="regenLog" class="p-2 rounded small mt-2" style="height:200px; overflow:auto;"></pre>
      </div>

      <div class="modal-footer">
        <div class="me-auto d-flex align-items-center gap-3">
          <label class="form-check-label">
            <input type="checkbox" class="form-check-input me-1" id="forceChk"> Force
          </label>
          <label class="form-check-label">
            <input type="checkbox" class="form-check-input me-1" id="hardChk"> Hard reset
          </label>
        </div>

        <div class="me-3">
          <button id="copyLogBtn" class="btn btn-outline-secondary btn-sm"><i class="fa fa-copy me-1"></i>Copy log</button>
          <button id="clearLogBtn" class="btn btn-outline-secondary btn-sm"><i class="fa fa-eraser me-1"></i>Clear</button>
        </div>
        <button id="regenStartBtn" class="btn btn-success"><i class="fa fa-play me-1"></i>Start</button>
        <button id="regenStopBtn" class="btn btn-warning" disabled><i class="fa fa-stop me-1"></i>Stop</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Sync Result -->
<div class="modal fade" id="syncResultModal" tabindex="-1" aria-labelledby="syncResultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="syncResultModalLabel">Sync report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="syncResultBody"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Syncing (loading padrão, backdrop estático) -->
<div class="modal fade" id="syncingModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body d-flex align-items-center gap-3">
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <div>
          <strong id="syncingTitle">Syncing…</strong>
          <div class="text-muted small" id="syncingSubtitle">Aguarde alguns instantes</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================= CSRF helpers ========================= */
function getCookie(name){
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}
const csrftoken = getCookie('csrftoken');
function csrfToken(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }

/* ========================= Util: Export ========================= */
function exportJobcardsExcel(){
  const url = '{% url "export_jobcard_excel" %}';
  window.open(url,'_blank');
}

/* ========================= Shortcuts: filtro em tempo real ========================= */
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('shortcutFilter');
  const list  = document.getElementById('shortcutsList');
  const empty = document.getElementById('shortcutsEmpty');
  if(!input || !list) return;

  const deb = (fn, t=150) => { let p; return (...a)=>{ clearTimeout(p); p=setTimeout(()=>fn(...a), t); }; };
  const apply = () => {
    const q = (input.value || '').toLowerCase().trim();
    let visible = 0;
    list.querySelectorAll('.js-shortcut').forEach(row => {
      const txt = row.textContent.toLowerCase();
      const show = !q || txt.includes(q);
      row.classList.toggle('d-none', !show);
      if(show) visible++;
    });
    empty?.classList.toggle('d-none', visible>0);
  };
  input.addEventListener('input', deb(apply, 120));
  apply();
});

/* ========================= Import (Template) ========================= */
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('importJobcardForm');
  if (!form) return;
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const fileInput = document.getElementById('importJobcardFile');
    if(!fileInput.files.length){
      return showImportResult('Error','Please select a file.');
    }
    const fd = new FormData(this);
    fetch("{% url 'import_jobcard_modify' %}", { method: "POST", body: fd })
    .then(r => r.json())
    .then(data => {
      const up = document.getElementById('importJobcardModal');
      if (up) bootstrap.Modal.getOrCreateInstance(up).hide();

      if (data.status === 'ok') {
        showImportResult('Success', `Updated: ${data.updated}`, true);
      } else if (data.status === 'not_found') {
        const missing = (data.missing || []).join(', ');
        showImportResult('Error', `These JobCards do not exist: ${missing}`);
      } else {
        showImportResult('Error', data.message || 'An error occurred!');
      }
    })
    .catch(() => showImportResult('Error','Upload failed.'));
  });

  function showImportResult(title, msg, reload){
    const titleEl = document.getElementById('resultJobcardModalLabel');
    const bodyEl  = document.getElementById('resultJobcardModalBody');

    titleEl.textContent = (title==='Success' ? 'Import Success' : 'Import Error');
    bodyEl.innerHTML = (title==='Success')
      ? `<div class="alert alert-success mb-2">${msg}</div>`
      : `<div class="alert alert-danger mb-2">${msg}</div>`;

    const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('resultJobcardModal'));
    m.show();
    if(reload){ setTimeout(()=>window.location.reload(), 1500); }
  }
});

/* ========================= PDF Regen UI ========================= */
(() => {
  let runId = null, startTs = 0;
  let total = 0, done = 0, fails = 0;
  let pollTimer = null;

  const $progress = document.getElementById('regenProgress');
  const $total    = document.getElementById('regenTotal');
  const $done     = document.getElementById('regenDone');
  const $fail     = document.getElementById('regenFail');
  const $elapsed  = document.getElementById('regenElapsed');
  const $eta      = document.getElementById('regenETA');
  const $tps      = document.getElementById('regenTPS');
  const $status   = document.getElementById('regenStatus');
  const $hbText   = document.getElementById('regenHeartbeatText');
  const $hbSpin   = document.getElementById('regenSpinner');
  const $log      = document.getElementById('regenLog');
  const $start    = document.getElementById('regenStartBtn');
  const $stop     = document.getElementById('regenStopBtn');
  const $runlab   = document.getElementById('regenRunId');
  const $force    = document.getElementById('forceChk');
  const $hard     = document.getElementById('hardChk');
  const $close    = document.getElementById('regenCloseBtn');

  function fmtTime(sec){
    if (!isFinite(sec) || sec < 0) return '--';
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = Math.floor(sec%60);
    return (h? String(h).padStart(2,'0')+':' : '') + String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }
  function setProgressActive(x){
    $progress.classList.toggle('progress-bar-striped', x);
    $progress.classList.toggle('progress-bar-animated', x);
  }
  function setStatus(txt, cls){
    $status.textContent = txt;
    $status.className = 'badge rounded-pill ' + (cls || 'bg-secondary');
  }
  function logLine(msg){
    const at = new Date().toLocaleTimeString();
    $log.textContent += `[${at}] ${msg}\n`; $log.scrollTop = $log.scrollHeight;
  }
  function toggleRunning(r){
    $start.disabled = r; $stop.disabled = !r;
    if ($close){ $close.style.pointerEvents = r ? 'none' : ''; $close.style.opacity = r ? .5 : 1; }
  }
  function startHeartbeat(text){
    stopHeartbeat(); $hbSpin.classList.remove('d-none'); $hbText.textContent = text;
    let dots = 0; window._hb = setInterval(()=>{ dots=(dots%3)+1; $hbText.textContent = text + '.'.repeat(dots); }, 500);
  }
  function stopHeartbeat(){
    if(window._hb){ clearInterval(window._hb); window._hb = null; }
    $hbSpin.classList.add('d-none'); $hbText.textContent = '';
  }

  function setProgressNumbers(){
    const pct = total ? Math.round((done/total)*100) : 0;
    $progress.style.width = pct + '%'; $progress.textContent = pct + '%';
    $total.textContent = total; $done.textContent = done; $fail.textContent = fails;
    const elapsedSec = startTs ? (Date.now() - startTs) / 1000 : 0;
    $elapsed.textContent = startTs ? fmtTime(elapsedSec) : '00:00';
    const rate = elapsedSec > 0 ? done / elapsedSec : 0;
    $tps.textContent = rate.toFixed(1);
    const remaining = Math.max(0, total - done);
    const etaSec = rate > 0 ? remaining / rate : NaN;
    $eta.textContent = startTs && isFinite(etaSec) ? fmtTime(etaSec) : '--';
  }

  function buildParams(){
    const params = new URLSearchParams();
    if ($force?.checked) params.append('force','1');
    if ($hard?.checked)  params.append('hard','1');
    return params.toString();
  }

  async function runStart(){
    const qs = buildParams();
    const url = "{% url 'api_pdf_run_start' %}" + (qs ? '?' + qs : '');
    const r = await fetch(url, { method:'POST', headers:{'X-CSRFToken': csrfToken()} });
    if(!r.ok){ throw new Error(`HTTP ${r.status}`); }
    const d = await r.json();
    if(d.status!=='ok' && d.status!=='attached') throw new Error(d.message||'Failed to start');
    return d;
  }

  async function pollProgress(){
    if(!runId) return;
    try{
      const r = await fetch("{% url 'api_pdf_run_progress' %}?run_id=" + encodeURIComponent(runId));
      if(!r.ok) return;
      const d = await r.json();
      if(d.status==='ok'){
        total = d.total || 0;
        done  = d.done  || 0;
        fails = d.err   || 0;
        setProgressNumbers();
        if (total > 0 && done >= total){
          clearInterval(pollTimer); setProgressActive(false); stopHeartbeat();
          setStatus('DONE','bg-success'); logLine('✅ Completed.'); toggleRunning(false);
        }
      }
    }catch(e){}
  }

  async function pollLog(){
    if(!runId) return;
    try{
      const r = await fetch("{% url 'api_pdf_run_log' %}?run_id=" + encodeURIComponent(runId));
      if(!r.ok) return;
      const d = await r.json();
      if(d.status === 'ok' && Array.isArray(d.log)){
        $log.textContent = d.log.join('\n'); $log.scrollTop = $log.scrollHeight;
      }
    }catch(e){}
  }

  $start?.addEventListener('click', async ()=>{
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    runId=null; total=done=fails=0; $log.textContent=''; startTs=Date.now();
    if ($runlab) $runlab.textContent = '—';
    setProgressNumbers(); setProgressActive(true); toggleRunning(true);
    setStatus('RUNNING','bg-primary'); startHeartbeat('Processing');

    try{
      const info = await runStart();
      if (info.status === 'attached') {
        runId = info.run_id; total = info.total || 0; done = info.done || 0;
        logLine(`Attached to running batch (run_id=${runId}).`);
      } else {
        runId = info.run_id; total = info.total || 0;
        logLine(`Run started (run_id=${runId}). Jobs enqueued…`);
      }
      if ($runlab) $runlab.textContent = runId;

      setProgressNumbers();
      if(total===0){
        logLine($force?.checked
          ? 'Nothing to do (maybe status filter).'
          : 'Everything cached. Check "Force" to rebuild.');
        setProgressActive(false); stopHeartbeat(); setStatus('IDLE','bg-secondary'); toggleRunning(false);
        return;
      }
      pollTimer = setInterval(() => { pollProgress(); pollLog(); }, 700);
    }catch(e){
      setProgressActive(false); stopHeartbeat(); setStatus('ERROR','bg-danger'); toggleRunning(false);
      logLine('Failed to start: ' + (e.message||e));
    }
  });

  $stop?.addEventListener('click', async ()=>{
    if(!runId) return;
    setStatus('STOPPING','bg-warning text-dark'); startHeartbeat('Stopping');

    const qs = new URLSearchParams();
    if ($hard?.checked) qs.append('hard','1');

    await fetch("{% url 'api_pdf_run_stop' %}" + (qs.toString() ? '?' + qs.toString() : ''), {
      method: 'POST', headers: {'X-CSRFToken': csrfToken()},
      body: new URLSearchParams({run_id})
    });

    logLine($hard?.checked
      ? 'Stop requested. Queue drained (hard=1). Running jobs will finish.'
      : 'Stop requested. Jobs not yet started will be aborted at start.');
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    setProgressActive(false); stopHeartbeat(); toggleRunning(false);
  });

  document.getElementById('copyLogBtn')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText($log.textContent||''); }catch{}
  });
  document.getElementById('clearLogBtn')?.addEventListener('click', ()=>{ $log.textContent=''; });
})();

/* ========================= Sync Result helpers (padrão) ========================= */
function showSyncModal(status, html, titleText){
  const body  = document.getElementById('syncResultBody');
  const title = document.getElementById('syncResultModalLabel');
  title.textContent = titleText || (status==='success' ? 'Sync Success' : status==='error' ? 'Sync Error' : 'Sync Report');
  body.innerHTML = html;
  bootstrap.Modal.getOrCreateInstance(document.getElementById('syncResultModal')).show();
}

function renderTotalsTable(totals, processed){
  const get = (sec, key) => {
    const x = totals?.[sec]?.[key];
    return (typeof x === 'number') ? x : 0;
  };
  const row = (name, label) => `
    <tr>
      <th>${label}</th>
      <td>${get(name,'created')}</td>
      <td>${get(name,'updated')}</td>
      <td>${get(name,'unchanged')}</td>
      <td>${get(name,'deleted')}</td>
    </tr>`;
  return `
    <div class="alert alert-success">Global sync finished. Processed: <strong>${processed||0}</strong> JobCards.</div>
    <table class="table table-sm mb-0">
      <thead>
        <tr>
          <th>Entity</th>
          <th>Created</th>
          <th>Updated</th>
          <th>Unchanged</th>
          <th>Deleted</th>
        </tr>
      </thead>
      <tbody>
        ${row('manpower','Manpower')}
        ${row('tools','Tools')}
        ${row('tasks','Tasks')}
        ${row('materials','Materials')}
        ${row('engineering','Engineering')}
      </tbody>
    </table>
  `;
}

/* ========================= Modal "Syncing…" padrão ========================= */
let syncingModal = null;
function openSyncing(title='Syncing…', subtitle='Aguarde alguns instantes'){
  const el = document.getElementById('syncingModal');
  document.getElementById('syncingTitle').textContent = title;
  document.getElementById('syncingSubtitle').textContent = subtitle;
  syncingModal = bootstrap.Modal.getOrCreateInstance(el);
  syncingModal.show();
}
function closeSyncing(){
  try{ syncingModal?.hide(); }catch(e){}
}

/* ========================= Sync ALL ========================= */
(() => {
  const btn = document.getElementById('btnSyncAll');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    if (!confirm('Run sync for ALL eligible JobCards? This may take a while.')) return;

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Syncing…`;
    openSyncing('Syncing ALL JobCards…', 'Isso pode levar alguns instantes');

    try {
      const discipline   = document.querySelector('[name="filter_discipline"]')?.value || '';
      const working_code = document.querySelector('[name="filter_working_code"]')?.value || '';
      const status       = document.querySelector('[name="filter_status"]')?.value || '';

      const res = await fetch(btn.dataset.url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
        body: new URLSearchParams({ delete_missing: '1', discipline, working_code, status })
      });

      const data = await res.json().catch(() => ({}));
      const ok = res.ok && data.ok;

      const html = ok
        ? renderTotalsTable(data.totals || {}, data.processed)
        : `<div class="alert alert-danger"><b>Sync failed:</b> ${data?.error || `HTTP ${res.status}`}</div>`;

      closeSyncing();
      showSyncModal(ok ? 'success':'error', html, ok ? 'Sync Success':'Sync Error');

      btn.innerHTML = ok ? `<i class="fa fa-check me-1"></i>Synced!`
                         : `<i class="fa fa-triangle-exclamation me-1"></i>Error`;
    } catch (err){
      closeSyncing();
      showSyncModal('error', `<div class="alert alert-danger"><b>Sync failed:</b> ${err?.message||err}</div>`, 'Sync Error');
      btn.innerHTML = `<i class="fa fa-triangle-exclamation me-1"></i>Error`;
    } finally {
      setTimeout(() => { btn.innerHTML = original; btn.disabled = false; }, 1200);
    }
  });
})();

/* ========================= Sync de UMA JobCard ========================= */
(() => {
  const btn = document.getElementById('btnSyncAllocated');
  if (!btn) return;

  function resolveUrl(){
    const run = btn.dataset.url || '';
    const tpl = btn.dataset.urlTemplate || '';
    if (run) return run;

    let jc = (btn.dataset.jc || '').trim()
          || (document.querySelector('#id_job_card_number')?.value || '').trim()
          || (document.querySelector('[name="job_card_number"]')?.value || '').trim();

    if (!jc || !tpl) return null;
    return tpl.replace('__JC__', encodeURIComponent(jc));
  }

  btn.addEventListener('click', async () => {
    const url = resolveUrl();
    if (!url){
      showSyncModal('error', `<div class="alert alert-danger">Please fill the JobCard Number first.</div>`, 'Sync Error');
      return;
    }

    btn.disabled = true;
    const original = btn.innerHTML;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Syncing…`;
    openSyncing('Syncing JobCard…', 'Atualizando entidades relacionadas');

    try{
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
      });

      const data = await res.json().catch(() => ({}));
      const ok = res.ok && data.ok;

      const r = data.report || {};
      const get = (sec, key) => (typeof (r?.[sec]?.[key]) === 'number') ? r[sec][key] : 0;
      const row = (name, label) => `
        <tr><th>${label}</th>
          <td>${get(name,'created')}</td>
          <td>${get(name,'updated')}</td>
          <td>${get(name,'unchanged')}</td>
          <td>${get(name,'deleted')}</td>
        </tr>`;

      const htmlOk = `
        <div class="alert alert-success">JobCard synced: <strong>${data.job_card_number || ''}</strong></div>
        <table class="table table-sm mb-0">
          <thead><tr><th>Entity</th><th>Created</th><th>Updated</th><th>Unchanged</th><th>Deleted</th></tr></thead>
          <tbody>
            ${row('materials','Materials')}
            ${row('tools','Tools')}
            ${row('engineering','Engineering')}
            ${row('manpower','Manpower')}
            ${row('tasks','Tasks')}
          </tbody>
        </table>
      `;

      closeSyncing();
      showSyncModal(ok ? 'success':'error',
        ok ? htmlOk : `<div class="alert alert-danger"><b>Sync failed:</b> ${data?.error || `HTTP ${res.status}`}</div>`,
        ok ? 'Sync Success':'Sync Error'
      );

      btn.innerHTML = ok ? `<i class="fa fa-check me-1"></i>Synced!`
                         : `<i class="fa fa-triangle-exclamation me-1"></i>Error`;
    } catch(err){
      closeSyncing();
      showSyncModal('error', `<div class="alert alert-danger"><b>Sync failed:</b> ${err?.message||err}</div>`, 'Sync Error');
      btn.innerHTML = `<i class="fa fa-triangle-exclamation me-1"></i>Error`;
    } finally {
      setTimeout(() => { btn.innerHTML = original; btn.disabled = false; }, 1200);
    }
  });
})();
</script>

{% endblock %}
