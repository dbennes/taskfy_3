{% extends 'sistema/base.html' %}
{% load static %}

{% block content %}
<style>
  /* ===== Design tokens (90% claro / 10% dark accent) ===== */
  :root{
    --bg:#f7f8fa; --panel:#ffffff; --ink:#0b0b0c; --muted:#6b7280;
    --line:#eceff3; --line-strong:#d9dee7; --hover:#f6f8fe; --zebra:#fbfcff;
    --accent:#111111; --accent-ghost:#171717;
    --radius:14px; --radius-lg:16px; --shadow:0 6px 18px rgba(0,0,0,.06);
    --green:#28c840; --red:#ff5f57; --yellow:#febc2e; --dark:#313131;
    --success:#16a34a; --warning:#f59e0b; --danger:#dc2626; --primary:#0d6efd;
  }

  body, .container-fluid { background:var(--bg) !important; }

  /* ===== Cards / textos ===== */
  .card-clean { background:#fff; border-radius:var(--radius-lg); box-shadow:var(--shadow); border:1px solid var(--line); overflow:hidden; }
  .muted { color:var(--muted); font-size:.9rem; }

  /* ===== Topbar estilo janela (escura, sticky) ===== */
  .topbar-black{
    position: sticky; top: 10px; z-index: 1010;
    background:var(--dark); border-radius:12px; padding:10px 12px; margin-bottom:12px;
    border:1px solid rgba(255,255,255,.06);
  }
  .topbar-black .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
  .dot.red{background:var(--red)} .dot.yellow{background:var(--yellow)} .dot.green{background:var(--green)}
  .topbar-title{ color:#fff; margin:0; font-size:.95rem; letter-spacing:.02em; }

  /* Botões do topbar: manter classes existentes e só melhorar legibilidade */
  .btn-topbar{
    --bs-btn-padding-y:.4rem; --bs-btn-padding-x:.65rem; --bs-btn-font-size:.82rem;
    border-radius:10px;
  }
  .topbar-black .btn-outline-light{
    --bs-btn-color:#e5e7eb; --bs-btn-border-color:#4b5563; --bs-btn-hover-bg:#e5e7eb; --bs-btn-hover-color:#111827;
    --bs-btn-hover-border-color:#e5e7eb; --bs-btn-active-bg:#fff; --bs-btn-active-color:#111827;
    background:rgba(255,255,255,.03);
  }
  .topbar-black .btn-primary.btn-sm{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }

  /* ===== Listas / atalhos ===== */
  .shortcut-item{
    border:1px solid var(--line); border-radius:12px; background:#fff;
    transition: transform .08s ease, box-shadow .12s ease, border-color .12s;
  }
  .shortcut-item:hover{ background:#fff; border-color:var(--line-strong); box-shadow:0 8px 22px rgba(16,24,40,.06); transform: translateY(-1px); }
  .shortcut-item .chev{ width:22px; height:22px; border-radius:50%; background:#f3f4f6; color:#111; display:inline-grid; place-items:center; font-weight:700; }

  /* ===== KPI pills ===== */
  .kpi{ display:flex; gap:12px; flex-wrap:wrap; }
  .kpi .item{ background:#f8fafc; border:1px solid #eef2f7; border-radius:12px; padding:10px 12px; min-width:120px; }
  .kpi .label{ font-size:.72rem; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; }
  .kpi .value{ font-weight:700; color:#111; }

  /* ===== Progress ===== */
  .progress{ height: 12px; background:#eef2f7; border-radius:999px; }
  .progress-bar{ background:linear-gradient(90deg, var(--primary), #60a5fa); font-size:.75rem; }

  /* ===== Log / mono ===== */
  #regenLog{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0b0b0c08; border:1px dashed var(--line-strong); }

  /* ===== Focus visível ===== */
  :is(button,a,input,select,.shortcut-item):focus-visible{
    outline: 2px solid #93c5fd; outline-offset: 2px; box-shadow: 0 0 0 4px rgba(147,197,253,.25);
  }

  /* ===== Responsivo ===== */
  @media (min-width: 992px) { .sticky-lg-top-16{ position: sticky; top: 16px; } }
</style>

<div class="container-fluid mt-2">

  <!-- Top black bar -->
  <div class="d-flex align-items-center justify-content-between topbar-black">
    <div class="d-flex align-items-center">
      <span class="dot red me-1"></span>
      <span class="dot yellow me-1"></span>
      <span class="dot green"></span>
      <h6 class="topbar-title ms-3">JobCards — Mass Update (Excel/CSV)</h6>
    </div>
    <div class="d-flex gap-2">
      <button id="btnSyncAll"
              class="btn btn-primary btn-sm btn-topbar"
              data-url="{% url 'jobcard_sync_allocations_all' %}">
        <i class="fa fa-arrows-rotate me-1"></i> Sync ALL JobCards
      </button>

      <button type="button" class="btn btn-outline-light btn-sm btn-topbar" data-bs-toggle="modal" data-bs-target="#regenModal">
        <i class="fa fa-sync-alt me-1"></i> Regenerate PDFs
      </button>

      <a href="{% url 'download_jobcard_template' %}" class="btn btn-outline-light btn-sm btn-topbar">
        <i class="fa fa-download me-1"></i> Template
      </a>

      <button type="button" class="btn btn-outline-light btn-sm btn-topbar" onclick="exportJobcardsExcel()">
        <i class="fa fa-file-excel me-1"></i> Export Excel
      </button>

      <button type="button" class="btn btn-success btn-sm btn-topbar" data-bs-toggle="modal" data-bs-target="#importJobcardModal">
        <i class="fa fa-upload me-1"></i> Import
      </button>
    </div>
  </div>

  {% if messages %}
    <div class="mb-2">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }} mb-2">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-3">
    <!-- LEFT: form -->
    <div class="col-12 col-lg-6">
      <div class="card-clean mb-3">
        <div class="p-3 border-bottom" style="background:#f5f7fb;">
          <h5 class="mb-0">Modify JobCard</h5>
          <div class="muted">Type the JobCard number to open the editor.</div>
        </div>

        <form method="post" class="p-3" novalidate>
          {% csrf_token %}
          <label class="form-label">JobCard Number</label>
          <input name="job_card_number" class="form-control mb-3" placeholder="A09.PS-EL-0001" list="jobcardsList" autofocus required>
          <datalist id="jobcardsList">
            {% for jc in recent_jobcards %}
              <option value="{{ jc.job_card_number }}">{{ jc.job_card_number }} — {{ jc.discipline }} {{ jc.location }}</option>
            {% endfor %}
          </datalist>
          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'modify_jobcard_entry' %}" class="btn btn-light">Clear</a>
            <button class="btn btn-primary" type="submit">Continue</button>
          </div>
        </form>
      </div>
    </div>

    <!-- RIGHT: shortcuts -->
    <div class="col-12 col-lg-6">
      <div class="card-clean sticky-lg-top-16">
        <div class="p-3 border-bottom" style="background:#f5f7fb;">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Shortcuts (recent)</h6>
            <span class="badge text-bg-light">{{ recent_jobcards|length }}</span>
          </div>
        </div>
        <div class="p-3">
          <input id="shortcutFilter" type="text" class="form-control mb-3" placeholder="Filter by number, discipline or area...">
          <div id="shortcutsList" class="row g-2">
            {% for jc in recent_jobcards %}
              <div class="col-12 js-shortcut">
                <a class="shortcut-item d-flex align-items-center p-2 text-decoration-none"
                   href="{% url 'modify_jobcard_edit' jobcard=jc.job_card_number %}">
                  <div class="flex-grow-1">
                    <strong class="text-dark">{{ jc.job_card_number }}</strong>
                    <div class="muted">
                      {{ jc.discipline }} · {{ jc.location }}{% if jc.last_modified_at %} · {{ jc.last_modified_at|date:"d/m/Y H:i" }}{% endif %}
                    </div>
                  </div>
                  <span class="ms-2 chev">&rsaquo;</span>
                </a>
              </div>
            {% empty %}
              <div class="col-12 muted">No suggestions yet.</div>
            {% endfor %}
          </div>
          <!-- Empty state do filtro -->
          <div id="shortcutsEmpty" class="text-center text-muted d-none">
            <i class="fa-regular fa-face-thinking me-1"></i>No results for this filter.
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- MODAL: Import -->
<div class="modal fade" id="importJobcardModal" tabindex="-1" aria-labelledby="importJobcardModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="importJobcardForm" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="importJobcardModalLabel">Import JobCard (Excel/CSV)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Download the <b>Template</b>, fill the desired columns and upload it here.<br>
          <small class="text-muted">Only provided columns will be updated; always identify by <code>job_card_number</code>.</small></p>
          <input type="file" name="file" id="importJobcardFile" accept=".xlsx,.csv" required class="form-control"/>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Import</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Result (para import) -->
<div class="modal fade" id="resultJobcardModal" tabindex="-1" aria-labelledby="resultJobcardModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="resultJobcardModalLabel">Import Result</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="resultJobcardModalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Regenerate PDFs -->
<div class="modal fade" id="regenModal" tabindex="-1" aria-labelledby="regenModalLabel" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <div class="d-flex flex-column">
          <h5 class="modal-title" id="regenModalLabel">Regenerate PDFs</h5>
          <small class="text-white-50">All JobCards whose status is <b>not</b> <code>NO CHECKED</code> / <code>NOT CHECKED</code> will be processed.</small>
        </div>
        <div class="ms-3 d-flex align-items-center">
          <span id="regenStatus" class="badge rounded-pill bg-secondary status-pill me-2">IDLE</span>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>

      <div class="modal-body">
        <div id="regenHeartbeat" class="d-flex align-items-center small text-muted mb-2" aria-live="polite">
          <span id="regenSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <span id="regenHeartbeatText"></span>
        </div>

        <div class="progress mb-2" role="progressbar" aria-label="Progress">
          <div id="regenProgress" class="progress-bar" style="width:0%;">0%</div>
        </div>

        <div class="kpi mb-2">
          <div class="item"><div class="label">Total</div><div class="value" id="regenTotal">0</div></div>
          <div class="item"><div class="label">Done</div><div class="value" id="regenDone">0</div></div>
          <div class="item"><div class="label">Failed</div><div class="value" id="regenFail">0</div></div>
          <div class="item"><div class="label">Elapsed</div><div class="value" id="regenElapsed">00:00</div></div>
          <div class="item"><div class="label">ETA</div><div class="value" id="regenETA">--</div></div>
          <div class="item"><div class="label">Throughput</div><div class="value"><span id="regenTPS">0</span>/s</div></div>
          <div class="item"><div class="label">Run ID</div><div class="value" id="regenRunId">—</div></div>
        </div>

        <pre id="regenLog" class="p-2 rounded small mt-2" style="height:200px; overflow:auto;"></pre>
      </div>

      <div class="modal-footer">
        <div class="me-auto d-flex align-items-center gap-3">
          <label class="form-check-label">
            <input type="checkbox" class="form-check-input me-1" id="forceChk"> Force
          </label>
          <label class="form-check-label">
            <input type="checkbox" class="form-check-input me-1" id="hardChk"> Hard reset
          </label>
        </div>

        <div class="me-3">
          <button id="copyLogBtn" class="btn btn-outline-secondary btn-sm"><i class="fa fa-copy me-1"></i>Copy log</button>
          <button id="clearLogBtn" class="btn btn-outline-secondary btn-sm"><i class="fa fa-eraser me-1"></i>Clear</button>
        </div>
        <button id="regenStartBtn" class="btn btn-success"><i class="fa fa-play me-1"></i>Start</button>
        <button id="regenStopBtn" class="btn btn-warning" disabled><i class="fa fa-stop me-1"></i>Stop</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Sync Result -->
<div class="modal fade" id="syncResultModal" tabindex="-1" aria-labelledby="syncResultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div id="syncResultHeader" class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="syncResultModalLabel">Sync report</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="syncResultBody"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========================= CSRF helpers ========================= */
function getCookie(name){
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}
const csrftoken = getCookie('csrftoken');
function csrfToken(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }

/* ========================= Util: Export ========================= */
function exportJobcardsExcel(){
  const url = '{% url "export_jobcard_excel" %}';
  window.open(url,'_blank');
}

/* ========================= Import (Template) ========================= */
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('importJobcardForm');
  if (!form) return;
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const fileInput = document.getElementById('importJobcardFile');
    if(!fileInput.files.length){ return showImportResult('Error','Please select a file.'); }

    const fd = new FormData(this);
    fetch("{% url 'import_jobcard_modify' %}", { method: "POST", body: fd })
    .then(r => r.json())
    .then(data => {
      const up = document.getElementById('importJobcardModal');
      if (up) bootstrap.Modal.getOrCreateInstance(up).hide();

      if (data.status === 'ok') {
        showImportResult('Success', `Updated: ${data.updated}`, true);
      } else if (data.status === 'not_found') {
        const missing = (data.missing || []).join(', ');
        showImportResult('Error', `These JobCards do not exist: ${missing}`);
      } else {
        showImportResult('Error', data.message || 'An error occurred!');
      }
    })
    .catch(() => showImportResult('Error','Upload failed.'));
  });

  function showImportResult(title, msg, reload){
    const header = document.querySelector('#resultJobcardModal .modal-header');
    const titleEl = document.getElementById('resultJobcardModalLabel');
    const bodyEl = document.getElementById('resultJobcardModalBody');

    if(title==='Success'){ header.classList.remove('bg-danger'); header.classList.add('bg-success'); titleEl.textContent = 'Import Success'; }
    else{ header.classList.remove('bg-success'); header.classList.add('bg-danger'); titleEl.textContent = 'Import Error'; }

    bodyEl.textContent = msg;

    const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('resultJobcardModal'));
    m.show();
    if(reload){ setTimeout(()=>window.location.reload(), 1500); }
  }
});

/* ========================= Shortcuts: filtro em tempo real (não interfere no restante) ========================= */
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('shortcutFilter');
  const list  = document.getElementById('shortcutsList');
  const empty = document.getElementById('shortcutsEmpty');
  if(!input || !list) return;

  const deb = (fn, t=150) => { let p; return (...a)=>{ clearTimeout(p); p=setTimeout(()=>fn(...a), t); }; };
  const apply = () => {
    const q = (input.value || '').toLowerCase().trim();
    let visible = 0;
    list.querySelectorAll('.js-shortcut').forEach(row => {
      const txt = row.textContent.toLowerCase();
      const show = !q || txt.includes(q);
      row.classList.toggle('d-none', !show);
      if(show) visible++;
    });
    empty?.classList.toggle('d-none', visible>0);
  };
  input.addEventListener('input', deb(apply, 120));
  apply();
});

/* ========================= PDF Regen UI ========================= */
(() => {
  let runId = null, startTs = 0;
  let total = 0, done = 0, fails = 0;
  let pollTimer = null;

  const $progress = document.getElementById('regenProgress');
  const $total    = document.getElementById('regenTotal');
  const $done     = document.getElementById('regenDone');
  const $fail     = document.getElementById('regenFail');
  const $elapsed  = document.getElementById('regenElapsed');
  const $eta      = document.getElementById('regenETA');
  const $tps      = document.getElementById('regenTPS');
  const $status   = document.getElementById('regenStatus');
  const $hbText   = document.getElementById('regenHeartbeatText');
  const $hbSpin   = document.getElementById('regenSpinner');
  const $log      = document.getElementById('regenLog');
  const $start    = document.getElementById('regenStartBtn');
  const $stop     = document.getElementById('regenStopBtn');
  const $runlab   = document.getElementById('regenRunId');
  const $force    = document.getElementById('forceChk');
  const $hard     = document.getElementById('hardChk');

  function fmtTime(sec){
    if (!isFinite(sec) || sec < 0) return '--';
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = Math.floor(sec%60);
    return (h? String(h).padStart(2,'0')+':' : '') + String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }
  function setProgressActive(x){ $progress.classList.toggle('progress-bar-striped', x); $progress.classList.toggle('progress-bar-animated', x); }
  function setStatus(txt, cls){ $status.textContent = txt; $status.className = 'badge rounded-pill status-pill ' + cls; }
  function logLine(msg){ const at = new Date().toLocaleTimeString(); $log.textContent += `[${at}] ${msg}\n`; $log.scrollTop = $log.scrollHeight; }
  function toggleRunning(r){
    $start.disabled = r; $stop.disabled = !r;
    const closeBtn = document.querySelector('#regenModal .modal-header .btn-close');
    if (closeBtn) { closeBtn.style.pointerEvents = r ? 'none' : ''; closeBtn.style.opacity = r ? .5 : 1; }
  }
  function startHeartbeat(text){
    stopHeartbeat(); $hbSpin.classList.remove('d-none'); $hbText.textContent = text;
    let dots = 0; window._hb = setInterval(()=>{ dots=(dots%3)+1; $hbText.textContent = text + '.'.repeat(dots); }, 500);
  }
  function stopHeartbeat(){ if(window._hb){ clearInterval(window._hb); window._hb = null; } $hbSpin.classList.add('d-none'); $hbText.textContent = ''; }

  function setProgressNumbers(){
    const pct = total ? Math.round((done/total)*100) : 0;
    $progress.style.width = pct + '%'; $progress.textContent = pct + '%';
    $total.textContent = total; $done.textContent = done; $fail.textContent = fails;
    const elapsedSec = startTs ? (Date.now() - startTs) / 1000 : 0;
    $elapsed.textContent = startTs ? fmtTime(elapsedSec) : '00:00';
    const rate = elapsedSec > 0 ? done / elapsedSec : 0;
    $tps.textContent = rate.toFixed(1);
    const remaining = Math.max(0, total - done);
    const etaSec = rate > 0 ? remaining / rate : NaN;
    $eta.textContent = startTs && isFinite(etaSec) ? fmtTime(etaSec) : '--';
  }

  function buildParams(){
    const params = new URLSearchParams();
    if ($force?.checked) params.append('force','1');
    if ($hard?.checked)  params.append('hard','1');
    return params.toString();
  }

  async function runStart(){
    const qs = buildParams();
    const url = "{% url 'api_pdf_run_start' %}" + (qs ? '?' + qs : '');
    const r = await fetch(url, { method:'POST', headers:{'X-CSRFToken': csrfToken()} });
    if(!r.ok){ throw new Error(`HTTP ${r.status}`); }
    const d = await r.json();
    if(d.status!=='ok' && d.status!=='attached') throw new Error(d.message||'Failed to start');
    return d;
  }

  async function pollProgress(){
    if(!runId) return;
    try{
      const r = await fetch("{% url 'api_pdf_run_progress' %}?run_id=" + encodeURIComponent(runId));
      if(!r.ok) return;
      const d = await r.json();
      if(d.status==='ok'){
        total = d.total || 0;
        done  = d.done  || 0;
        fails = d.err   || 0;
        setProgressNumbers();
        if (total > 0 && done >= total){
          clearInterval(pollTimer); setProgressActive(false); stopHeartbeat();
          setStatus('DONE','bg-success'); logLine('✅ Completed.'); toggleRunning(false);
        }
      }
    }catch(e){}
  }

  async function pollLog(){
    if(!runId) return;
    try{
      const r = await fetch("{% url 'api_pdf_run_log' %}?run_id=" + encodeURIComponent(runId));
      if(!r.ok) return;
      const d = await r.json();
      if(d.status === 'ok' && Array.isArray(d.log)){
        $log.textContent = d.log.join('\n'); $log.scrollTop = $log.scrollHeight;
      }
    }catch(e){}
  }

  $start?.addEventListener('click', async ()=>{
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    runId=null; total=done=fails=0; $log.textContent=''; startTs=Date.now();
    if ($runlab) $runlab.textContent = '—';
    setProgressNumbers(); setProgressActive(true); toggleRunning(true);
    setStatus('RUNNING','bg-primary'); startHeartbeat('Processing');

    try{
      const info = await runStart();
      if (info.status === 'attached') {
        runId = info.run_id; total = info.total || 0; done = info.done || 0;
        logLine(`Attached to running batch (run_id=${runId}).`);
      } else {
        runId = info.run_id; total = info.total || 0;
        logLine(`Run started (run_id=${runId}). Jobs enqueued…`);
      }
      if ($runlab) $runlab.textContent = runId;

      setProgressNumbers();
      if(total===0){
        logLine($force?.checked
          ? 'Nothing to do (maybe status filter).'
          : 'Everything cached. Check "Force" to rebuild.');
        setProgressActive(false); stopHeartbeat(); setStatus('IDLE','bg-secondary'); toggleRunning(false);
        return;
      }
      pollTimer = setInterval(() => { pollProgress(); pollLog(); }, 700);
    }catch(e){
      setProgressActive(false); stopHeartbeat(); setStatus('ERROR','bg-danger'); toggleRunning(false);
      logLine('Failed to start: ' + (e.message||e));
    }
  });

  $stop?.addEventListener('click', async ()=>{
    if(!runId) return;
    setStatus('STOPPING','bg-warning text-dark'); startHeartbeat('Stopping');

    const qs = new URLSearchParams();
    if ($hard?.checked) qs.append('hard','1');

    await fetch("{% url 'api_pdf_run_stop' %}" + (qs.toString() ? '?' + qs.toString() : ''), {
      method: 'POST', headers: {'X-CSRFToken': csrfToken()},
      body: new URLSearchParams({run_id})
    });

    logLine($hard?.checked
      ? 'Stop requested. Queue drained (hard=1). Running jobs will finish.'
      : 'Stop requested. Jobs not yet started will be aborted at start.');
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    setProgressActive(false); stopHeartbeat(); toggleRunning(false);
  });

  document.getElementById('copyLogBtn')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText($log.textContent||''); }catch{}
  });
  document.getElementById('clearLogBtn')?.addEventListener('click', ()=>{
    $log.textContent='';
  });
})();

/* ========================= Sync Result Modal (helpers) ========================= */
function showSyncModal(status, html, titleText){
  const header = document.getElementById('syncResultHeader');
  const body   = document.getElementById('syncResultBody');
  const title  = document.getElementById('syncResultModalLabel');

  title.textContent = titleText || (status === 'success' ? 'Sync Success' :
                                    status === 'error'   ? 'Sync Error'   :
                                                          'Sync Report');

  header.classList.remove('bg-success','bg-danger','bg-secondary','bg-dark');
  header.classList.add(status === 'success' ? 'bg-success' :
                       status === 'error'   ? 'bg-danger'   : 'bg-dark');

  body.innerHTML = html;

  const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('syncResultModal'));
  m.show();
}

function renderTotalsTable(totals, processed){
  const get = (sec, key) => {
    const x = totals?.[sec]?.[key];
    return (typeof x === 'number') ? x : 0;
  };
  const row = (name, label) => `
    <tr>
      <th>${label}</th>
      <td>${get(name,'created')}</td>
      <td>${get(name,'updated')}</td>
      <td>${get(name,'unchanged')}</td>
      <td>${get(name,'deleted')}</td>
    </tr>`;

  return `
    <div class="alert alert-success">
      Global sync finished. Processed: <strong>${processed||0}</strong> JobCards.
    </div>
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Entity</th>
          <th>Created</th>
          <th>Updated</th>
          <th>Unchanged</th>
          <th>Deleted</th>
        </tr>
      </thead>
      <tbody>
        ${row('manpower','Manpower')}
        ${row('tools','Tools')}
        ${row('tasks','Tasks')}
        ${row('materials','Materials')}
        ${row('engineering','Engineering')}
      </tbody>
    </table>
  `;
}

/* ========================= Sync ALL (Base → Allocated) ========================= */
(() => {
  const btn = document.getElementById('btnSyncAll');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    if (!confirm('Run sync for ALL eligible JobCards? This may take a while.')) return;

    btn.disabled = true;
    const original = btn.textContent;
    btn.textContent = 'Syncing all...';

    try {
      const discipline   = document.querySelector('[name="filter_discipline"]')?.value || '';
      const working_code = document.querySelector('[name="filter_working_code"]')?.value || '';
      const status       = document.querySelector('[name="filter_status"]')?.value || '';

      const res = await fetch(btn.dataset.url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
        body: new URLSearchParams({
          delete_missing: '1',
          discipline, working_code, status
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        const msg = data?.error || `HTTP ${res.status}`;
        showSyncModal('error', `<div class="alert alert-danger"><b>Sync failed:</b> ${msg}</div>`, 'Sync Error');
        throw new Error(msg);
      }

      const html = renderTotalsTable(data.totals || {}, data.processed);
      showSyncModal('success', html, 'Sync Success');
      btn.textContent = 'Synced!';
    } catch (err){
      console.error('Sync ALL error:', err);
      btn.textContent = 'Error';
    } finally {
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1200);
    }
  });
})();

/* ========================= Sync de UMA JobCard (se existir botão) ========================= */
(() => {
  const btn = document.getElementById('btnSyncAllocated');
  if (!btn) return;

  function resolveUrl(){
    const run = btn.dataset.url || '';
    const tpl = btn.dataset.urlTemplate || '';
    if (run) return run;

    let jc = (btn.dataset.jc || '').trim()
          || (document.querySelector('#id_job_card_number')?.value || '').trim()
          || (document.querySelector('[name="job_card_number"]')?.value || '').trim();

    if (!jc || !tpl) return null;
    return tpl.replace('__JC__', encodeURIComponent(jc));
  }

  btn.addEventListener('click', async () => {
    const url = resolveUrl();
    if (!url){
      showSyncModal('error', `<div class="alert alert-danger">Please fill the JobCard Number first.</div>`, 'Sync Error');
      return;
    }

    btn.disabled = true;
    const original = btn.textContent;
    btn.textContent = 'Syncing…';

    try{
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        const msg = data?.error || `HTTP ${res.status}`;
        showSyncModal('error', `<div class="alert alert-danger"><b>Sync failed:</b> ${msg}</div>`, 'Sync Error');
        throw new Error(msg);
      }

      const r = data.report || {};
      const get = (sec, key) => {
        const x = r?.[sec]?.[key];
        return (typeof x === 'number') ? x : 0;
      };
      const row = (name, label) => `
        <tr><th>${label}</th>
          <td>${get(name,'created')}</td>
          <td>${get(name,'updated')}</td>
          <td>${get(name,'unchanged')}</td>
          <td>${get(name,'deleted')}</td>
        </tr>`;

      const html = `
        <div class="alert alert-success">
          JobCard synced: <strong>${data.job_card_number || ''}</strong>
        </div>
        <table class="table table-sm">
          <thead>
            <tr><th>Entity</th><th>Created</th><th>Updated</th><th>Unchanged</th><th>Deleted</th></tr>
          </thead>
          <tbody>
            ${row('materials','Materials')}
            ${row('tools','Tools')}
            ${row('engineering','Engineering')}
            ${row('manpower','Manpower')}
            ${row('tasks','Tasks')}
          </tbody>
        </table>
      `;

      showSyncModal('success', html, 'Sync Success');
      btn.textContent = 'Synced!';
    } catch(err){
      console.error('Sync error:', err);
      btn.textContent = 'Error';
    } finally {
      setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1200);
    }
  });
})();
</script>

{% endblock %}
