{% extends 'sistema/base.html' %}
{% load static %}

{% block content %}
<style>
    .taskfy-table td {
        font-size: 11px;
        padding: 9px 16px !important;
        vertical-align: middle;
        background: #fff !important;
    }
    .taskfy-table th {
        font-size: 11px;
        padding: 9px 16px !important;
        vertical-align: middle;
        background: #ffffffff !important;   /* Aqui você muda a cor */
        color: #23272e !important;           /* Texto branco */
        font-weight: 700;
        letter-spacing: .04em;
        border-top: none;
        border-bottom: 1px solid #adadadff;
        text-align: left;
    }
    .taskfy-table tr:hover {
        background: #f0f6fd !important;
        transition: 0.14s;
    }
    .taskfy-badge {
        font-size: 11px;
        font-weight: 600;
        border-radius: 18px;
        padding: 4px 14px 4px 10px;
        margin-left: 2px;
        display: inline-flex;
        align-items: center;
        min-width: 40px;
        box-shadow: none;
        border: none;
        gap: 6px;
    }
    .taskfy-badge-available {
        background: #e7f9ed;
        color: #249d63;
        border: 1px solid #d6f3e0;
    }
    .taskfy-badge-unavailable {
        background: #fff1f1;
        color: #ea4646;
        border: 1px solid #ffd7d7;
    }
    .taskfy-badge-waiting {
        background: #ecebfa;
        color: #7563e0;
        border: 1px solid #e1dcfb;
    }
    .taskfy-table-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: center;
    }
    .taskfy-btn {
        font-size: 12px !important;
        border-radius: 16px !important;
        padding: 5px 18px !important;
        min-width: 88px;
        box-shadow: 0 2px 8px #ebebeb4f;
        display: flex;
        align-items: center;
        gap: 7px;
        font-weight: 600;
        border: none;
    }
    .taskfy-btn:disabled, .taskfy-btn[disabled] {
        opacity: 0.58;
        background: #e9e9e9 !important;
        color: #888 !important;
    }
    .table-modal-title {
        font-size: 1.03rem;
        font-weight: 700;
        color: #233;
    }
    .modal-header {
        background: #f5f5f8;
        border-bottom: 1px solid #eee;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        min-height: 46px;
    }
    .modal-title i {
        color: #6ea3e8;
        margin-right: 8px;
    }
    @media (max-width: 900px) {
        .taskfy-table th, .taskfy-table td { font-size: 10px; padding: 4px 7px !important;}
        .taskfy-btn { min-width: 62px;}
    }
    .table-responsive {
        margin-bottom: 0;
        border-radius: 12px;
        overflow: hidden;
    }
    .taskfy-table {
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 0;
    }
</style>

<div class="container-fluid px-1">

    <!-- APPLE STYLE HEADER & ACTIONS -->
    <div class="d-flex align-items-center justify-content-between p-2 mb-3" style="background-color: #313131; border-radius: 8px;">
        <div class="d-flex align-items-center me-3">
            <span style="width: 10px; height: 10px; background-color: #ff5f57; border-radius: 50%; display: inline-block; margin-right: 5px;"></span>
            <span style="width: 10px; height: 10px; background-color: #febc2e; border-radius: 50%; display: inline-block; margin-right: 5px;"></span>
            <span style="width: 10px; height: 10px; background-color: #28c840; border-radius: 50%; display: inline-block;"></span>
            <h6 class="mb-0 ms-3 text-white">Jobcard Planning - Complete Database View</h6>
        </div>
        <div class="d-flex gap-2 mb-2">
            <form id="exportForm" method="get" action="{% url 'export_mr_excel' %}">
                <input type="hidden" name="mr_number" id="export_mr_number">
                <input type="hidden" name="pmto_code" id="export_pmto_code">
                <input type="hidden" name="basic_material" id="export_basic_material">
                <button type="submit" class="btn btn-outline-light btn-sm">
                    <i class="fa fa-file-excel me-1"></i> Export Excel
                </button>
            </form>
        </div>
    </div>

    <!-- FILTROS -->
    <form method="get" class="row align-items-end mb-3" style="font-size:13px">
        <div class="col-md-2">
            <label for="itemsPerPage" class="form-label">Items per page:</label>
            <select id="itemsPerPage" name="items_per_page" class="form-select" style="font-size:13px">
                <option value="5" {% if items_per_page == "5" %}selected{% endif %}>5</option>
                <option value="10" {% if items_per_page == "10" or not items_per_page %}selected{% endif %}>10</option>
                <option value="20" {% if items_per_page == "20" %}selected{% endif %}>20</option>
                <option value="50" {% if items_per_page == "50" %}selected{% endif %}>50</option>
                <option value="100" {% if items_per_page == "100" %}selected{% endif %}>100</option>
                <option value="100000" {% if items_per_page == "100000" %}selected{% endif %}>Todos</option>
            </select>
        </div>
        <div class="col-md-5">
            <label for="filterInput" class="form-label">Search:</label>
            <input style="font-size:13px" type="text" id="filterInput" name="search" value="{{ search }}" class="form-control" placeholder="Buscar...">
        </div>
        <div class="col-md-2">
            <label for="startDate" class="form-label">Start:</label>
            <input style="font-size:13px" type="date" id="startDate" name="start_date" value="{{ request.GET.start_date }}" class="form-control">
        </div>
        <div class="col-md-2">
            <label for="endDate" class="form-label">Finish:</label>
            <input style="font-size:13px" type="date" id="endDate" name="end_date" value="{{ request.GET.end_date }}" class="form-control">
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary p-2" style="font-size: 13px; width: 100%; height: 40px; background: #63b784; border: none">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>
    </form>



    <div class="table-responsive mt-2">
        <table class="table taskfy-table table-hover align-middle shadow-sm mb-2" id="dataTable">
            <thead style="background:#23272e;">
                <tr>
                    <th>JOBCARD</th>
                    <th>WORKPACK</th>
                    <th>DISCIPLINE</th>
                    
                    <th>WORKING CODE</th>
                    <th>START</th>
                    <th>FINISH</th>
                    <th>
                        <i class="fa-solid fa-cubes" title="Materiais"></i>
                        MATERIALS
                    </th>
                    <th>
                        <i class="fa-solid fa-file-lines" title="Documentos"></i>
                        DOCS
                    </th>
                    <th class="text-center"><i class="fa-solid fa-bolt" title="Ação"></i>ACTION</th>
                </tr>
            </thead>
            <tbody>
                {% for obj in jobcards_data %}
                <tr>
                    <td><span class="fw-semibold">{{ obj.job.job_card_number }}</span></td>
                    <td>{{ obj.job.workpack_number }}</td>
                    <td>{{ obj.job.discipline }}</td>
                    
                    <td>{{ obj.job.working_code }}</td>
                    <td>{% if obj.start %}{{ obj.start|date:"d/m/Y" }}{% else %}--{% endif %}</td>
                    <td>{% if obj.finish %}{{ obj.finish|date:"d/m/Y" }}{% else %}--{% endif %}</td>
                    <td>
                        <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#materiaisModal{{ obj.job.job_card_number }}">
                            <span class="taskfy-badge
                                {% if obj.total_materials == 0 %}
                                    taskfy-badge-waiting
                                {% elif obj.all_materials_available %}
                                    taskfy-badge-available
                                {% else %}
                                    taskfy-badge-unavailable
                                {% endif %}
                                d-inline-flex
                            ">
                                {% if obj.total_materials == 0 %}
                                    <i class="fa-solid fa-minus"></i>
                                {% elif obj.all_materials_available %}
                                    <i class="fa-solid fa-circle-check"></i>
                                {% else %}
                                    <i class="fa-solid fa-triangle-exclamation"></i>
                                {% endif %}
                                &nbsp;{{ obj.total_materials }}
                            </span>
                        </a>
                        <!-- Modal Materiais -->
                        <div class="modal fade" id="materiaisModal{{ obj.job.job_card_number }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <div class="modal-title table-modal-title">
                                            <i class="fa-solid fa-cubes"></i> Materials for <b>{{ obj.job.job_card_number }}</b>
                                        </div>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body p-2">
                                        <table class="table table-sm align-middle mb-0">
                                            <thead><tr><th>Description</th><th>PMTO Code</th><th>Qty</th><th>Status</th></tr></thead>
                                            <tbody>
                                                {% for mat in obj.materials_status %}
                                                <tr>
                                                    <td>{{ mat.description }}</td>
                                                    <td>{{ mat.pmto_code }}</td>
                                                    <td>{{ mat.qty }}</td>
                                                    <td>
                                                        {% if mat.available %}
                                                            <span class="taskfy-badge taskfy-badge-available"><i class="fa-solid fa-circle-check"></i> &nbsp;Available</span>
                                                        {% else %}
                                                            <span class="taskfy-badge taskfy-badge-unavailable"><i class="fa-solid fa-circle-xmark"></i> &nbsp;Missing</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="4">No allocated materials.</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#docsModal{{ obj.job.job_card_number }}">
                            <span class="taskfy-badge
                                {% if obj.total_docs == 0 %}
                                    taskfy-badge-waiting
                                {% elif obj.all_docs_available %}
                                    taskfy-badge-available
                                {% else %}
                                    taskfy-badge-unavailable
                                {% endif %}
                                d-inline-flex
                            ">
                                {% if obj.total_docs == 0 %}
                                    <i class="fa-solid fa-minus"></i>
                                {% elif obj.all_docs_available %}
                                    <i class="fa-solid fa-circle-check"></i>
                                {% else %}
                                    <i class="fa-solid fa-triangle-exclamation"></i>
                                {% endif %}
                                &nbsp;{{ obj.total_docs }}
                            </span>
                        </a>
                        <!-- Modal Documentos -->
                        <div class="modal fade" id="docsModal{{ obj.job.job_card_number }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <div class="modal-title table-modal-title">
                                            <i class="fa-solid fa-file-lines"></i> Documents for <b>{{ obj.job.job_card_number }}</b>
                                        </div>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body p-2">
                                        <table class="table table-sm align-middle mb-0">
                                            <thead><tr><th>Document</th><th>Rev</th><th>Status</th></tr></thead>
                                            <tbody>
                                                {% for doc in obj.docs_status %}
                                                <tr>
                                                    <td>{{ doc.document }}</td>
                                                    <td>{{ doc.rev }}</td>
                                                    <td>
                                                        {% if doc.available %}
                                                            <span class="taskfy-badge taskfy-badge-available"><i class="fa-solid fa-circle-check"></i> &nbsp;Available</span>
                                                        {% else %}
                                                            <span class="taskfy-badge taskfy-badge-unavailable"><i class="fa-solid fa-circle-xmark"></i> &nbsp;Missing</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="3">No allocated documents.</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="taskfy-table-actions">
                            {% if obj.can_advance %}
                                <form method="post" action="{% url 'change_jobcard_status' obj.job.job_card_number %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button class="btn btn-success taskfy-btn" style="background: #d0fbd2; color: #055509;" type="submit" data-bs-toggle="tooltip" data-bs-placement="left" title="Advance status">
                                        <i class="fa-solid fa-circle-play"></i> Release Jobcard
                                    </button>
                                </form>
                            {% else %}
                                <button class="btn btn-secondary taskfy-btn" disabled data-bs-toggle="tooltip" data-bs-placement="left" title="Waiting for all materials and docs to be available">
                                    <i class="fa-solid fa-clock"></i> Waiting
                                </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

        <!-- PAGINAÇÃO -->
    <nav aria-label="Page navigation example" class="mt-2">
        <ul class="pagination justify-content-end">
            {% if jobcards.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?search={{ search }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&items_per_page={{ items_per_page }}&page={{ jobcards.previous_page_number }}" aria-label="Previous">&laquo;</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% for num in jobcards.paginator.page_range %}
                {% if jobcards.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > jobcards.number|add:"-3" and num < jobcards.number|add:"3" %}
                    <li class="page-item"><a class="page-link" href="?search={{ search }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&items_per_page={{ items_per_page }}&page={{ num }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if jobcards.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?search={{ search }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&items_per_page={{ items_per_page }}&page={{ jobcards.next_page_number }}" aria-label="Next">&raquo;</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
        </ul>
    </nav>

    

</div>
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}
