{% extends 'sistema/base.html' %}
{% load static %}

{% block content %}
<style>
  /* ===== Design tokens (alinhados ao topbar) ===== */
  :root{
    --bg:#f7f8fa; --panel:#ffffff; --ink:#0b0b0c; --muted:#6b7280;
    --line:#eceff3; --line-strong:#d9dee7; --hover:#f6f8fe;
    --brand:#879aff; --icon:#858796;
    --shadow:0 8px 28px rgba(16,24,40,.06);
    --radius:14px; --r-sm:12px;
  }

  .page-wrap{ background:var(--bg); }
  .card-uber{
    background:var(--panel); border:1px solid var(--line);
    border-radius:var(--radius); box-shadow:var(--shadow);
    overflow:hidden; transition:transform .06s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .card-uber:hover{ border-color:var(--line-strong); box-shadow:0 10px 36px rgba(16,24,40,.08); }

  /* Cabeçalho de card (estilo “uber”) */
  .card-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg,#fff,#fbfbfd);
  }
  .card-title{
    display:flex; align-items:center; gap:.5rem;
    font-weight:700; font-size:1rem; letter-spacing:.2px; color:#1f2937;
  }
  .card-title i{ color:var(--icon); }

  /* Subtítulo/legenda */
  .muted{ color:var(--muted); }

  /* Avatar com iniciais */
  .avatar-xl{
    width:64px; height:64px; border-radius:999px; display:grid; place-items:center;
    background:#111; color:#fff; font-weight:700; letter-spacing:.5px;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.15);
  }

  /* Chips */
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    background:#f4f5f8; border:1px solid var(--line-strong);
    border-radius:999px; padding:5px 10px; font-size:.86rem; margin:2px 6px 2px 0;
  }
  .chip i{ font-size:.85rem; color:var(--icon); }

  /* Mini KPIs */
  .kpi{
    display:flex; align-items:center; gap:10px; padding:10px 12px;
    border:1px solid var(--line); border-radius:12px; background:#fff;
  }
  .kpi .ico{
    width:32px; height:32px; border-radius:10px; display:grid; place-items:center;
    border:1px solid var(--line); color:var(--icon); background:#fff;
  }
  .kpi strong{ font-size:1.05rem; color:#1f2937; }
  .kpi small{ color:var(--muted); }

  /* Botões “fantasma” e “dark” */
  .btn-ghost{
    background:#fff; color:#111; border:1px solid var(--line-strong); border-radius:12px;
    padding:.6rem .9rem; transition:background-color .15s ease, border-color .15s ease, transform .05s ease;
  }
  .btn-ghost:hover{ background:#fafafa; border-color:#dfe5ef; }
  .btn-ghost:active{ transform:translateY(1px); }

  .btn-dark{
    background:#111; color:#fff; border:0; border-radius:12px; padding:.6rem 1rem;
    box-shadow:0 2px 0 rgba(0,0,0,.12);
  }
  .btn-dark:active{ transform:translateY(1px); }

  /* Inputs */
  .form-label{ font-weight:600; color:#2c2f36; font-size:.92rem; }
  .form-control{
    border:1px solid var(--line-strong); border-radius:12px; padding:.6rem .8rem;
    font-size:.95rem; transition:border-color .15s ease, box-shadow .15s ease;
    background:#fff;
  }
  .form-control:focus{ border-color:#cfd6e5; box-shadow:0 0 0 .2rem rgba(135,154,255,.18); }
  .form-control[disabled]{ background:#fafafd; color:#697185; }

  .divider{ height:1px; background:var(--line); margin:14px 0; }
  .label-small{ font-size:.86rem; color:#616673; }

  /* Lista de sessões */
  .session{
    display:flex; align-items:center; justify-content:space-between;
    border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin-bottom:8px;
  }
  .session .info{ display:flex; align-items:center; gap:10px; }
  .session .device{
    width:34px; height:34px; border-radius:10px; display:grid; place-items:center;
    border:1px solid var(--line); color:var(--icon); background:#fff;
  }

  /* Switch minimal */
  .form-switch .form-check-input{
    width:2.25em; height:1.25em; cursor:pointer;
  }

  /* Modal: sem borda branca! */
  .modal-content{
    border-radius:14px !important;
    border:1px solid #1f2328 !important;   /* <<< borda escura */
    box-shadow:0 20px 48px rgba(0,0,0,.22);
  }
  .modal-header{
    background:#21262b; color:#fff; border-bottom:1px solid rgba(255,255,255,.12) !important; /* <<< sem linha branca */
  }
  .modal-footer{ border-top:1px solid var(--line-strong); }

  /* Mostrar/ocultar senha */
  .reveal-wrap{ position:relative; }
  .reveal-btn{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    border:0; background:transparent; color:#6b7280; padding:0; line-height:0;
  }
  .reveal-btn:hover{ color:#374151; }
  .reveal-btn i{ font-size:1rem; }

  /* Layout responsivo */
  @media (max-width: 991.98px){
    .card-title{ font-size:.98rem; }
  }
</style>

<div class="container-fluid page-wrap">
  <div class="row g-4">

    <!-- Mensagens Django -->
    <div class="col-12">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} border-1" role="alert" style="border-radius:12px;">{{ message }}</div>
        {% endfor %}
      {% endif %}
    </div>

    <!-- COL ESQUERDA: Snapshot + Ações + Sessões -->
    <div class="col-12 col-lg-4">
      <!-- Snapshot -->
      <div class="card-uber">
        <div class="card-head">
          <div class="card-title"><i class="fa-regular fa-id-badge"></i> Profile Snapshot</div>
        </div>
        <div class="p-4">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div id="avatarInitials" class="avatar-xl">U</div>
            <div>
              <div class="fw-bold">{{ request.user.get_full_name|default:request.user.username }}</div>
              <div class="muted">{{ request.user.email|default:"—" }}</div>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-12">
              <div class="kpi">
                <div class="ico"><i class="fa-regular fa-clock"></i></div>
                <div>
                  <strong>{{ request.user.last_login|date:"d/m/Y H:i" }}</strong><br>
                  <small class="muted">Last login</small>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="kpi">
                <div class="ico"><i class="fa-regular fa-calendar"></i></div>
                <div>
                  <strong>{{ request.user.date_joined|date:"d/m/Y" }}</strong><br>
                  <small class="muted">Member since</small>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-2 fw-semibold">Groups</div>
          <div class="mb-3">
            {% if groups %}
              {% for g in groups %}
                <span class="chip"><i class="fa-solid fa-users"></i>{{ g }}</span>
              {% endfor %}
            {% else %}
              <div class="muted">No group assigned.</div>
            {% endif %}
          </div>

          <div class="d-grid gap-2">
            <a href="{% url 'upload_documents' %}" class="btn-ghost">
              <i class="fa-regular fa-folder-open me-1"></i> Upload Documents
            </a>
            <a href="{% url 'modify_jobcard_entry' %}" class="btn-ghost">
              <i class="fa-regular fa-file-lines me-1"></i> New/Modify Jobcard
            </a>
          </div>
        </div>
      </div>

      <!-- Sessões ativas (opcional: se você passar 'sessions' no contexto) -->
      <div class="card-uber mt-4">
        <div class="card-head">
          <div class="card-title"><i class="fa-regular fa-display"></i> Active Sessions</div>
        </div>
        <div class="p-3">
          {% if sessions %}
            {% for s in sessions %}
              <div class="session">
                <div class="info">
                  <div class="device"><i class="fa-regular fa-desktop"></i></div>
                  <div>
                    <div class="fw-semibold">{{ s.user_agent|default:"Unknown device" }}</div>
                    <div class="muted">{{ s.ip|default:"—" }} • {{ s.last_seen|date:"d/m/Y H:i" }}</div>
                  </div>
                </div>
                <!-- Placeholder: ação local (não quebra nada) -->
                <button class="btn btn-sm btn-outline-danger" type="button" disabled>Sign out</button>
              </div>
            {% endfor %}
          {% else %}
            <div class="muted px-1">No session details available.</div>
          {% endif %}
        </div>
      </div>

      <!-- Preferências (salvas localmente) -->
      <div class="card-uber mt-4">
        <div class="card-head">
          <div class="card-title"><i class="fa-regular fa-sliders"></i> Preferences</div>
        </div>
        <div class="p-3">
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="pref-compact">
            <label class="form-check-label" for="pref-compact">Compact spacing</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="pref-email-notify" checked>
            <label class="form-check-label" for="pref-email-notify">Email notifications</label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="pref-news-tips">
            <label class="form-check-label" for="pref-news-tips">Tips & product news</label>
          </div>
        </div>
      </div>
    </div>

    <!-- COL DIREITA: Detalhes da conta + Segurança -->
    <div class="col-12 col-lg-8">
      <!-- Detalhes da conta -->
      <div class="card-uber">
        <div class="card-head">
          <div class="card-title"><i class="fa-regular fa-user"></i> Account Details</div>
        </div>

        <div class="p-4">
          <form method="post" action="{% url 'user_profile' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_profile">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Username</label>
                <input class="form-control" value="{{ request.user.username }}" disabled>
                <div class="label-small mt-1">Usernames are not editable.</div>
              </div>
              <div class="col-md-6">
                <label for="id_email" class="form-label">Email</label>
                {{ form.email }}
              </div>
              <div class="col-md-6">
                <label for="id_first_name" class="form-label">First name</label>
                {{ form.first_name }}
              </div>
              <div class="col-md-6">
                <label for="id_last_name" class="form-label">Last name</label>
                {{ form.last_name }}
              </div>
            </div>

            <div class="divider"></div>

            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
              <div class="label-small">
                <i class="fa-regular fa-clock me-1"></i>
                Last login: {{ request.user.last_login|date:"d/m/Y H:i" }} &nbsp;•&nbsp;
                Member since: {{ request.user.date_joined|date:"d/m/Y" }}
              </div>
              <button type="submit" class="btn-dark">
                <i class="fa-regular fa-floppy-disk me-1"></i> Save changes
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Segurança & Acesso -->
      <div class="card-uber mt-4">
        <div class="card-head">
          <div class="card-title"><i class="fa-solid fa-shield-halved"></i> Security & Access</div>
        </div>
        <div class="p-4">
          <div class="row g-3">
            <div class="col-12 col-xl-7">
              <div class="d-flex justify-content-between align-items-start align-items-md-center gap-2">
                <div>
                  <div class="fw-semibold mb-1">Password</div>
                  <div class="muted">Keep your password unique and strong.</div>
                </div>
                <button class="btn-ghost" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                  <i class="fa-regular fa-eye-slash me-1"></i> Change Password
                </button>
              </div>

              <div class="divider"></div>

              <div class="d-flex justify-content-between align-items-start align-items-md-center gap-2">
                <div>
                  <div class="fw-semibold mb-1">Two-factor authentication</div>
                  <div class="muted">Add an extra layer of security to your account.</div>
                </div>
                <button class="btn-ghost" type="button" disabled>
                  <i class="fa-regular fa-shield-keyhole me-1"></i> Configure (soon)
                </button>
              </div>
            </div>

            <div class="col-12 col-xl-5">
              <div class="bg-white border rounded-3 p-3" style="border-color:var(--line);">
                <div class="fw-semibold mb-1">Security tips</div>
                <ul class="m-0 ps-3 label-small">
                  <li>Use a unique password for Taskfy.</li>
                  <li>Enable 2FA when available.</li>
                  <li>Review active sessions regularly.</li>
                </ul>
              </div>
            </div>
          </div><!-- /row -->
        </div>
      </div>
    </div><!-- /col direita -->
  </div>
</div>

<!-- Modal: Change Password (AJAX, inline errors, sem recarregar) -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title text-white d-flex align-items-center">
          <i class="fa-solid fa-lock me-2"></i> Change Password
        </h6>
        <button type="button" class="btn border-0 bg-transparent p-0 d-flex align-items-center" data-bs-dismiss="modal" aria-label="Close">
          <span style="width:12px;height:12px;background:#ff5f57;border-radius:50%;display:inline-block;" class="me-1"></span>
          <span style="width:12px;height:12px;background:#febc2e;border-radius:50%;display:inline-block;" class="me-1"></span>
          <span style="width:12px;height:12px;background:#28c840;border-radius:50%;display:inline-block;"></span>
        </button>
      </div>

      <form id="pwdForm" method="post" novalidate>
        {% csrf_token %}
        <div class="modal-body">
          <div id="pwdFormAlert" class="alert d-none" role="alert"></div>

          <div class="mb-3 js-reveal">
            <label class="form-label" for="id_old_password">Current password</label>
            {{ pwd_form.old_password }}
          </div>

          <div class="mb-3 js-reveal">
            <label class="form-label" for="id_new_password1">New password</label>
            {{ pwd_form.new_password1 }}
            {% if pwd_form.help_text %}
              <div class="form-text">{{ pwd_form.help_text|safe }}</div>
            {% endif %}
          </div>

          <div class="mb-1 js-reveal">
            <label class="form-label" for="id_new_password2">Confirm new password</label>
            {{ pwd_form.new_password2 }}
          </div>
        </div>

        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="pwdSubmitBtn" type="submit" class="btn btn-success">
            <span class="btn-label">Save password</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
/* ==== Avatar com iniciais (client-side, não altera server) ==== */
(function(){
  const el = document.getElementById('avatarInitials');
  if (!el) return;
  const full = "{{ request.user.get_full_name|default:request.user.username }}".trim();
  const token = full || "User";
  const parts = token.split(/\s+/).slice(0,2);
  const initials = parts.map(p => p[0] ? p[0].toUpperCase() : '').join('') || 'U';
  el.textContent = initials;
})();

/* ==== Preferências locais (compact/tips/emails) ==== */
(function(){
  const root = document.querySelector('.page-wrap');
  const compact = document.getElementById('pref-compact');
  const emailN = document.getElementById('pref-email-notify');
  const tips = document.getElementById('pref-news-tips');

  function load(key, def){ try{ return JSON.parse(localStorage.getItem(key) ?? JSON.stringify(def)); }catch{ return def; } }
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  const st = load('taskfy:prefs', {compact:false,email:true,tips:false});
  if (compact) { compact.checked = !!st.compact; compact.addEventListener('change', ()=>{ st.compact = compact.checked; save('taskfy:prefs', st); root.classList.toggle('compact', st.compact); }); }
  if (emailN) { emailN.checked = !!st.email;  emailN.addEventListener('change', ()=>{ st.email = emailN.checked; save('taskfy:prefs', st); }); }
  if (tips)   { tips.checked   = !!st.tips;   tips.addEventListener('change', ()=>{ st.tips = tips.checked; save('taskfy:prefs', st); }); }

  if (st.compact){ root.classList.add('compact'); }
})();

/* Compact mode (só reduz paddings levemente) */
(function(){
  const css = `
    .compact .card-uber .p-4{ padding:1rem !important; }
    .compact .card-uber .p-3{ padding:.75rem !important; }
    .compact .card-head{ padding:10px 14px !important; }
    .compact .form-control{ padding:.5rem .7rem !important; }
    .compact .btn-ghost, .compact .btn-dark{ padding:.5rem .85rem !important; }
  `;
  const tag = document.createElement('style'); tag.textContent = css; document.head.appendChild(tag);
})();

/* ==== Change Password (AJAX) – mantém a mesma lógica + toggle show/hide ==== */
(function(){
  const form = document.getElementById('pwdForm');
  if (!form) return;

  const alertBox = document.getElementById('pwdFormAlert');
  const submitBtn = document.getElementById('pwdSubmitBtn');
  const spinner = submitBtn.querySelector('.spinner-border');
  const btnLabel = submitBtn.querySelector('.btn-label');
  const endpoint = "{% url 'api_change_password' %}";

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function showTop(type, msgHtml){
    alertBox.classList.remove('d-none','alert-danger','alert-success');
    alertBox.classList.add('alert', type === 'success' ? 'alert-success' : 'alert-danger');
    alertBox.innerHTML = msgHtml;
  }
  function clearErrors(){
    alertBox.classList.add('d-none'); alertBox.classList.remove('alert-danger','alert-success');
    alertBox.innerHTML = '';
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    form.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
  }
  function setFieldError(fieldName, messages){
    const input = form.querySelector(`[name="${fieldName}"]`);
    if (!input) return;
    input.classList.add('is-invalid');
    let fb = input.nextElementSibling;
    if (!fb || !fb.classList.contains('invalid-feedback')){
      fb = document.createElement('div');
      fb.className = 'invalid-feedback d-block';
      input.insertAdjacentElement('afterend', fb);
    }
    fb.innerHTML = (messages || []).map(m => escapeHtml(m)).join('<br>');
  }
  async function safeParseJson(resp){
    const ctype = resp.headers.get('content-type') || '';
    if (ctype.includes('application/json')) {
      try { return await resp.json(); } catch { return null; }
    }
    return null;
  }
  function getCsrfToken(){
    const hidden = form.querySelector('input[name="csrfmiddlewaretoken"]');
    if (hidden && hidden.value) return hidden.value;
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  async function submitPwd(e){
    e.preventDefault();
    clearErrors();
    submitBtn.disabled = true; spinner.classList.remove('d-none'); btnLabel.classList.add('d-none');

    try{
      const formData = new FormData(form);
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": getCsrfToken(),
          "Accept": "application/json"
        },
        body: formData,
        redirect: "follow"
      });

      if (resp.redirected) {
        showTop('danger', "Your session has expired. Please reload the page and sign in again.");
        return;
      }

      const data = await safeParseJson(resp);

      if (resp.ok && data && data.ok){
        showTop('success', escapeHtml(data.message || "Password changed successfully."));
        form.reset();
        return;
      }

      if (resp.status === 403){
        if (data && data.errors) {
          Object.keys(data.errors).forEach(name => setFieldError(name, data.errors[name]));
        }
        showTop('danger', "Permission or CSRF validation failed. Please reload this page and try again.");
        return;
      }

      if (resp.status === 404){
        showTop('danger', "Endpoint not found (404). Check your URL routing for 'api_change_password'.");
        return;
      }

      if (data && (data.errors || data.non_field_errors)){
        const errs = data.errors || {};
        Object.keys(errs).forEach(name => setFieldError(name, errs[name]));
        if (data.non_field_errors && data.non_field_errors.length){
          showTop('danger', data.non_field_errors.map(escapeHtml).join('<br>'));
        } else if (!Object.keys(errs).length){
          showTop('danger', "Please correct the errors and try again.");
        }
        return;
      }

      const text = await resp.text();
      const snippet = escapeHtml((text || '').slice(0, 400));
      showTop('danger', `Unexpected server response (status ${resp.status}).<br><small>${snippet}</small>`);

    } catch (err){
      showTop('danger', "Network or parsing error. Please check your connection and try again.");
    } finally {
      submitBtn.disabled = false; spinner.classList.add('d-none'); btnLabel.classList.remove('d-none');
    }
  }

  form.addEventListener('submit', submitPwd);

  /* Mostrar/ocultar senha (gera sem mexer nos names/IDs do Django) */
  function enhanceReveal(){
    form.querySelectorAll('.js-reveal').forEach(block => {
      const input = block.querySelector('input[type="password"], input[name$="password"], input[type="text"][name*="password"]');
      if (!input || block.classList.contains('reveal-ready')) return;
      block.classList.add('reveal-ready');

      const wrap = document.createElement('div');
      wrap.className = 'reveal-wrap';
      input.parentNode.insertBefore(wrap, input);
      wrap.appendChild(input);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'reveal-btn';
      btn.innerHTML = '<i class="fa-regular fa-eye"></i>';
      wrap.appendChild(btn);

      let visible = false;
      btn.addEventListener('click', () => {
        visible = !visible;
        input.setAttribute('type', visible ? 'text' : 'password');
        btn.innerHTML = visible
          ? '<i class="fa-regular fa-eye-slash"></i>'
          : '<i class="fa-regular fa-eye"></i>';
      });
    });
  }

  const modalEl = document.getElementById('changePasswordModal');
  if (modalEl){
    modalEl.addEventListener('shown.bs.modal', function(){
      // limpa erros antigos e aplica reveals
      const alertBox = document.getElementById('pwdFormAlert');
      alertBox.classList.add('d-none'); alertBox.classList.remove('alert-danger','alert-success'); alertBox.innerHTML = '';
      form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
      form.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
      enhanceReveal();
    });
  }
})();
</script>
{% endblock %}
