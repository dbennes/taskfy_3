{% load static %}
<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
        <title>TASKFY</title>

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}">

        <!-- FontAwesome, Google Fonts e jQuery -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

        <!-- JS do Bootstrap (precisa do Popper.js também) -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

        <!-- Select2 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

        <!-- Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    </head>

    <body style="background: #14191c; min-height: 100vh; display: flex; flex-direction: column;">

    <div id="wrapper" class="d-flex flex-grow-1" style="min-height: 100vh; width: 100%;">

        {% include 'sistema/partials/_menu_lateral.html' %}

        <div id="content-wrapper" class="d-flex flex-column flex-grow-1" style="width: 100%;">

            <div id="content" class="flex-grow-1 p-3">
                {% block content %}
                {% endblock %}
            </div>

        </div>

    </div>

    {# templates/partials/permission_denied_modal.html #}
    <div id="perm-modal" class="perm-modal is-hidden" aria-hidden="true" role="dialog" aria-labelledby="perm-modal-title">
      <div class="perm-backdrop" data-close="1"></div>
      <div class="perm-card" role="document">
        <div class="perm-head">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 13h-2v2h2v-2Zm0-8h-2v6h2V7Z"/>
          </svg>
          <h3 id="perm-modal-title">Access denied</h3>
        </div>
        <p id="perm-modal-text">{{ modal_message|default:"Access denied. You do not have sufficient privileges to perform this action. If you believe this is an error, please contact your system administrator." }}</p>
        <div class="perm-actions">
          <button type="button" class="perm-btn" data-close="1">OK</button>
        </div>
      </div>
    </div>

    <style>
    /* Minimalistic, dependency-free modal */
    .perm-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
    .perm-modal.is-hidden{display:none}
    .perm-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px)}
    .perm-card{position:relative;width:min(92vw,520px);background:#fff;border-radius:16px;padding:20px 18px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .perm-head{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .perm-head svg{fill:#111}
    .perm-head h3{margin:0;font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    #perm-modal-text{color:#555;margin:6px 2px 0 2px;font:400 14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .perm-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}
    .perm-btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;background:#111;color:#fff;font:600 14px/1 system-ui;cursor:pointer}
    .perm-btn:focus{outline:2px solid #1114;outline-offset:2px}
    </style>

    <script>
    (function(){
      const modal = document.getElementById('perm-modal');
      if(!modal) return;

      function show(msg){
        if(msg){ const el = document.getElementById('perm-modal-text'); if(el) el.textContent = msg; }
        modal.classList.remove('is-hidden');
        modal.setAttribute('aria-hidden','false');
        // cleanup possible redirect anchors
        try{ history.replaceState(null,'',location.pathname+location.search); }catch(_){}
      }
      function hide(){
        modal.classList.add('is-hidden');
        modal.setAttribute('aria-hidden','true');
      }
      modal.addEventListener('click', (e)=>{ if(e.target.dataset.close) hide(); });
      // extra: close with ESC (non-breaking)
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !modal.classList.contains('is-hidden')) hide(); });

      // expose globally for AJAX
      window.showPermissionDeniedModal = show;

      // Inject Django messages tagged as "modal-permission"
      {% if messages %}
        {% for m in messages %}
          {% if 'modal-permission' in m.tags %}
            window.addEventListener('DOMContentLoaded', function(){
              show("{{ m|escapejs }}");
            });
          {% endif %}
        {% endfor %}
      {% endif %}
    })();
    </script>

    {% include 'sistema/partials/_footer.html' %}

    <!-- Scripts do Bootstrap -->
    <script src="{% static 'assets/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

    <script>
    function atualizarContadorRevisoes() {
        fetch('/api/revisoes_ultimas/?count=1')
        .then(resp => resp.json())
        .then(data => {
            let qtd = data.revisoes ? data.revisoes.length : 0;
            let badge = document.getElementById('contador-revisoes');
            if (qtd > 0) {
                badge.innerText = qtd;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        });
    }
    setInterval(atualizarContadorRevisoes, 5000);
    window.onload = atualizarContadorRevisoes;

    function marcarNotificacoesComoLidas() {
        // 1. Marca como lidas no backend (usando a data mais recente das notificações exibidas)
        if (window.revisoesData && window.revisoesData.length > 0) {
            const ultimaData = window.revisoesData[0].data_mudanca_db;
            fetch('/api_notificacoes_lidas/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ultima_data: ultimaData }),
            });
        }

        // 2. Some o contador do sininho imediatamente (efeito visual)
        const badge = document.getElementById('contador-revisoes');
        if (badge) {
            badge.innerText = '0';
            badge.style.display = 'none';
        }
    }
    </script>

    <!-- OPTIONAL: intercept 403 from fetch/jQuery and open the modal (non-breaking) -->
    <script>
    (function(){
      if(window.fetch){
        const _fetch = window.fetch;
        window.fetch = function(input, init){
          init = init || {};
          const hdrs = new Headers(init.headers || {});
          if(!hdrs.has('X-Requested-With')) hdrs.set('X-Requested-With','XMLHttpRequest');
          if(!hdrs.has('Accept')) hdrs.set('Accept','application/json');
          init.headers = hdrs;

          return _fetch(input, init).then(async (res)=>{
            if(res.status === 403){
              let msg = "Access denied. You do not have sufficient privileges to perform this action. If you believe this is an error, please contact your system administrator.";
              try { const data = await res.clone().json(); msg = data.message || data.error || msg; } catch(_){}
              window.showPermissionDeniedModal && window.showPermissionDeniedModal(msg);
            }
            return res;
          });
        };
      }

      if(window.jQuery && window.jQuery.ajax){
        jQuery(document).ajaxError((_, xhr)=>{
          if(xhr && xhr.status === 403){
            let msg = "Access denied. You do not have sufficient privileges to perform this action. If you believe this is an error, please contact your system administrator.";
            try { const data = JSON.parse(xhr.responseText); msg = data.message || data.error || msg; } catch(_){}
            window.showPermissionDeniedModal && window.showPermissionDeniedModal(msg);
          }
        });
      }
    })();
    </script>

    </body>
</html>
